var WORKSPACE={VIEW:1,DEBUG:!1,PeerOptions:{key:"rv687hwetjz41jor",config:{iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"turn:numb.viagenie.ca:3478?transport=udp",credential:"muazkh",username:"webrtc@live.com"},{url:"turn:numb.viagenie.ca:3478?transport=tcp",credential:"muazkh",username:"webrtc@live.com"}]},debug:2,secure:"https:"==window.location.protocol},ViewModels:{},GridLayers:[],ErasePoints:{},GridImageOverlay:null,PreviousMapImage:null,IsLoaded:!1,ShowDistance:!1,TokenSize:{T:12,S:50,M:50,L:100,H:150,G:250,C:400},CRArray:["","0","1/8","1/4","1/2",1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],XPPerLevel:{1:[25,50,75,100],2:[50,100,150,200],3:[75,150,225,400],4:[125,250,375,500],5:[250,500,750,1100],6:[300,600,900,1400],7:[350,750,1100,1700],8:[450,900,1400,2100],9:[550,1100,1600,2400],10:[600,1200,1900,2800],11:[800,1600,2400,3600],12:[1e3,2e3,3e3,4500],13:[1100,2200,3400,5100],14:[1250,2500,3800,5700],15:[1400,2800,4300,6400],16:[1600,3200,4800,7200],17:[2e3,3900,5900,8800],18:[2100,4200,6300,9500],19:[2400,4900,7300,10900],20:[2800,5700,8500,12700]},XPPerCR:{0:10,"1/8":25,"1/4":50,"1/2":100,1:200,2:450,3:700,4:1100,5:1800,6:2300,7:2900,8:3900,9:5e3,10:5900,11:7200,12:8400,13:1e4,14:11500,15:13e3,16:15e3,17:18e3,18:2e4,19:22e3,20:25e3,21:33e3,22:41e3,23:5e4,24:62e3,25:75e3,26:9e4,27:105e3,28:12e4,29:135e3,30:155e3},Multipliers:[1,1.5,2,2.5,3,4,5],DistanceFrom:{top:0,left:0}};WORKSPACE.Helpers={DrawFog:function(){if(WORKSPACE.ViewModels.CombatViewModel&&WORKSPACE.ViewModels.CombatViewModel.ShowFog()){var e=$("#grid-fog")[0],t=e.getContext("2d"),o=WORKSPACE.ViewModels.CombatViewModel.FogColor();t.clearRect(0,0,e.width,e.height),t.globalCompositeOperation="source-over",t.fillStyle=o,t.fillRect(0,0,e.width,e.height);var a=WORKSPACE.ViewModels.CombatViewModel.GridZoom(),r=WORKSPACE.ErasePoints[a];for(i=0;r&&i<r.points.length;i++){var n=r.points[i].x,s=r.points[i].y;t.beginPath(),i>0&&r.points[i].dragging?t.moveTo(r.points[i-1].x,r.points[i-1].y):t.moveTo(n-1,s),t.lineTo(n,s),t.closePath(),t.globalCompositeOperation="destination-out",t.fillStyle="rgba(0,0,0,0);",t.strokeStyle="rgba(0,0,0,0);",t.lineJoin="round",t.lineWidth=r.points[i].size,t.stroke()}}},DrawLights:function(){if(WORKSPACE.ViewModels.CombatViewModel.ShowDarkness()){var e=$("#grid-light"),t=e[0].getContext("2d"),o=600*WORKSPACE.ViewModels.CombatViewModel.TokenScale(),i=2*o,a=WORKSPACE.ViewModels.CombatViewModel.DarknessColor().replace(")",", 0.9)").replace("rgb","rgba"),r=(WORKSPACE.ViewModels.CombatViewModel.DarknessColor().replace(")",", 0.6)").replace("rgb","rgba"),WORKSPACE.ViewModels.CombatViewModel.DarknessColor().replace(")",", 0)").replace("rgb","rgba")),n=WORKSPACE.GridMap.getSize();t.clearRect(0,0,e[0].width,e[0].height),e.css("top",-i+"px"),e.css("left",-i+"px"),e.attr("width",n.x+2*i+"px"),e.attr("height",n.y+2*i+"px"),$(".leaflet-marker-icon").each(function(e,n){var s=$(n);if(s.hasClass("player")){var l=s.offset(),p=l.left+s.width()/2+i,d=l.top+s.height()/2+i,c=t.createRadialGradient(p,d,0,p,d,o);c.addColorStop(1,r),c.addColorStop(.5,a),c.addColorStop(0,a),t.fillStyle=c,t.fillRect(p-o,d-o,p+o,d+o)}}),t.fillStyle=a,t.globalCompositeOperation="xor",t.fillRect(0,0,n.x+2*i,n.y+2*i)}},DisableDistance:function(e){if(e.which>1){var t=$("#grid-canvas")[0],o=t.getContext("2d");WORKSPACE.ShowDistance=!1,o.clearRect(0,0,t.width,t.height)}},DrawDistance:function(e){if(WORKSPACE.ShowDistance){var t=$("#grid-canvas"),o={left:WORKSPACE.DistanceFrom.left-t.offset().left,top:WORKSPACE.DistanceFrom.top-t.offset().top},i={left:e.pageX-t.offset().left,top:e.pageY-t.offset().top},a=t[0].getContext("2d"),r=o.left,n=o.top,s=i.left,l=i.top,p=0;a.clearRect(0,0,t[0].width,t[0].height),p=WORKSPACE.Helpers.DrawLabel(a,{x:r,y:n},{x:s,y:l},"center","5"),p>2&&(a.setLineDash([5,5]),a.beginPath(),a.moveTo(r,n),a.lineTo(s,l),a.strokeStyle="red",a.stroke())}},DrawLabel:function(e,t,o,i,a){i||(i="center"),a||(a=0);var r,n,s,l=o.x-t.x,p=o.y-t.y,d=Math.sqrt(l*l+p*p),c=0,h=Math.atan2(p,l);if((h<-Math.PI/2||h>Math.PI/2)&&(r=t,t=o,o=r,l*=-1,p*=-1,h-=Math.PI),"center"==i)r=t,n=.5;else{var g="left"==i;r=g?t:o,n=a/Math.sqrt(l*l+p*p)*(g?1:-1)}return e.font="14px Arial",c=(d/50*5).toFixed(1),s=c+" ft",c>2&&(e.save(),e.textAlign=i,e.translate(r.x+l*n,r.y+p*n),e.rotate(Math.atan2(p,l)),e.fillStyle="red",e.fillText(s,0,-5),e.restore()),c},SwapMap:function(e){if(WORKSPACE.PreviousMapImage!=e){WORKSPACE.PreviousMapImage=e;var t=new Image;t.onload=function(){var e=t.height,o=t.width,i=o/e,a=[[0,0],[100,100*i]];WORKSPACE.GridImageOverlay&&WORKSPACE.GridMap.removeLayer(WORKSPACE.GridImageOverlay),WORKSPACE.GridImageOverlay=new L.imageOverlay(t.src,a),WORKSPACE.GridImageOverlay.addTo(WORKSPACE.GridMap),WORKSPACE.GridMap.fitBounds(a)},t.src=e}},Throttle:function(e,t){var o=!1;return function(){o||(e.call(),o=!0,setTimeout(function(){o=!1},t))}}},WORKSPACE.Shim=function(){L.Map=L.Map.extend({openPopup:function(e,t,o){if(!(e instanceof L.Popup)){var i=e;e=new L.Popup(o).setContent(i)}return t&&e.setLatLng(t),this.hasLayer(e)?this:(this._popup=e,this.addLayer(e))},closePopup:function(e){return e&&e!==this._popup||(e=this._popup,this._popup=null),e&&(this.removeLayer(e),e._isOpen=!1),this},bindPopup:function(e,t){var o=L.point(this.options.icon.options.popupAnchor||[0,0]);return o=o.add(L.Popup.prototype.options.offset),t&&t.offset&&(o=o.add(t.offset)),t=L.extend({offset:o},t),this._popupHandlersAdded||(this.on("click",this.togglePopup,this).on("remove",this.closePopup,this).on("move",this._movePopup,this),this._popupHandlersAdded=!0),e instanceof L.Popup?(L.setOptions(e,t),this._popup=e,e._source=this):this._popup=new L.Popup(t,this).setContent(e),this}}),WORKSPACE.GridMap=new L.map("grid-map",{crs:L.CRS.Simple,minZoom:1,maxZoom:7,attributionControl:!1,zoomControl:!1,scrollWheelZoom:!1,touchZoom:!1,doubleClickZoom:!1,boxZoom:!1,dragging:!0});var e=WORKSPACE.GridMap;e.on("contextmenu",function(e){}),e.on("mousemove",function(e){WORKSPACE.Helpers.DrawDistance(e.originalEvent)}),e.on("mouseup",function(e){WORKSPACE.Helpers.DisableDistance(e.originalEvent)}),$(document).on("mouseup",function(e){WORKSPACE.Helpers.DisableDistance(e)}),e.on("move",function(e){var t=$("#grid-lines"),o=$(".leaflet-image-layer"),i=$("#grid-fog");i[0].getContext("2d");t&&o[0]&&(t.css("transform",o[0].style.transform),t.css("width",o.width()),t.css("height",o.height()),i.css("transform",o[0].style.transform),i.attr("width",o.width()),i.attr("height",o.height()),WORKSPACE.Helpers.DrawFog())}),e.on("mousedown",function(e){var t=e.originalEvent,o=WORKSPACE.DistanceFrom;t.stopPropagation(),2==t.button&&(o.left=t.pageX,o.top=t.pageY,WORKSPACE.ShowDistance=!0)}),e.on("load",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("viewreset",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("moveend",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("zoomend",function(e){WORKSPACE.AdjustFog(),WORKSPACE.Helpers.DrawLights()}),e.on("zoomlevelschange",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("zoomlevelschange",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("layeradd",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("dragend",function(e){WORKSPACE.Helpers.DrawLights()}),WORKSPACE.ResizeGrid=function(e){var t=$("#CombatViewModel"),o=$("#grid-canvas"),i=t.height(),a=t.width();o.attr("height",i),o.attr("width",a),WORKSPACE.GridMap&&e&&WORKSPACE.GridMap.invalidateSize()},WORKSPACE.ResizeGrid(),$(window).resize(function(){WORKSPACE.ResizeGrid(!0)}),$("#grid-lines").appendTo($(".leaflet-map-pane")),$("#grid-fog").appendTo($(".leaflet-map-pane")),WORKSPACE.DrawFog=function(){if(WORKSPACE.ViewModels.CombatViewModel&&WORKSPACE.ViewModels.CombatViewModel.ShowFog()){var e=$("#grid-fog")[0],t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),t.globalCompositeOperation="source-over",t.fillStyle=WORKSPACE.ViewModels.CombatViewModel.FogColor().replace(")",", 0.65)").replace("rgb","rgba"),t.fillRect(0,0,e.width,e.height)}},WORKSPACE.AdjustFog=function(){var e=$("#grid-fog"),t=(e[0].getContext("2d"),$(".leaflet-image-layer"));e.css("transform",t[0].style.transform),e.attr("width",t.width()),e.attr("height",t.height()),WORKSPACE.Helpers.DrawFog()},WORKSPACE.DrawFog()};