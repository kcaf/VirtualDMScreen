var CombatantModel=function(){var e=this;e.Id=ko.observable().extend({trackChange:!0}),e.ModelType=ko.observable().extend({trackChange:!0}),e.Size=ko.observable().extend({trackChange:!0}),e.Name=ko.observable().extend({trackChange:!0}),e.Initiative=ko.observable().extend({trackChange:!0}),e.AC=ko.observable().extend({trackChange:!0}),e.HP=ko.observable().extend({trackChange:!0}),e.Skip=ko.observable().extend({trackChange:!0}),e.Effects=ko.observableArray().extend({trackChange:!0}),e.Level=ko.observable().extend({trackChange:!0}),e.CR=ko.observable().extend({trackChange:!0}),e.MaxHP=ko.observable().extend({trackChange:!0}),e.PositionTop=ko.observable("").extend({trackChange:!0}),e.PositionLeft=ko.observable("").extend({trackChange:!0}),e.ZIndex=ko.observable(0).extend({trackChange:!0}),e.LatLng=ko.observable().extend({trackChange:!0}),e.Token=ko.observable(null).extend({trackChange:!0}),e.Angle=ko.observable(0).extend({trackChange:!0}),e.CurrentLink=null,e.ClickY=null,e.ClickX=null,e.Name.subscribe(function(t){$.each(WORKSPACE.ViewModels.CombatViewModel.CustomIcons(),function(t,o){o.name==e.Name()&&(e.Token(o.token),WORKSPACE.ViewModels.CombatViewModel.LoadTokens())})}),e.PickToken=function(t,o){var n=prompt("Token URL","");n&&(e.Token(n),WORKSPACE.ViewModels.CombatViewModel.LoadTokens())},e.ViewCombatant=function(t,o){null!==e.Id()&&"NPC"==e.ModelType()&&WORKSPACE.Helpers.ViewNPC(e.Id(),o)},e.Distance=function(e,t){var o=0,n=0;return o=t.x-e.x,o*=o,n=t.y-e.y,n*=n,Math.sqrt(o+n)},e.MouseMove=function(t,o){WORKSPACE.Clicked&&e.DragScroll(o)},e.MouseDown=function(t,o){WORKSPACE.Clicked=!0,e.ClickY=o.pageY,e.ClickX=o.pageX;var n=$(o.currentTarget),a=parseInt(n.css("left").slice(0,-2)),r=parseInt(n.css("top").slice(0,-2));e.CurrentLink={left:a,top:r}},e.MouseUp=function(t,o){var n=$("#grid-canvas")[0],a=n.getContext("2d");a.clearRect(0,0,n.width,n.height),e.CurrentLink=null,WORKSPACE.Clicked=!1},e.DragScroll=function(t){var o=$(t.currentTarget),n=o.position();e.PositionLeft(n.left+"px"),e.PositionTop(n.top+"px"),e.ZIndex(o.css("z-index")),e.Connect(t)},e.TokenClass=ko.pureComputed(function(){var t=e.HP()<=0?" dead":"";return"grid-token "+(e.ModelType()?e.ModelType().toLowerCase():"unknown")+"-row"+t+" size-"+e.Size()}),e.Style=ko.pureComputed(function(){return"left: "+e.PositionLeft()+"; top: "+e.PositionTop()+";"}),e.RowClass=ko.pureComputed(function(){var t=e.HP()<=0?" dead":"";return(e.ModelType()?e.ModelType().toLowerCase():"unknown")+"-row"+t+" size-"+e.Size()}),e.NameShort=ko.pureComputed(function(){return e.Name()&&e.Name().length?e.Name().slice(0,1):e.Name()}),e.XP=ko.pureComputed(function(){return e.CR()?WORKSPACE.XPPerCR[e.CR()]:0}),e.ACBasic=ko.pureComputed({read:function(){return e.AC()?e.AC().split(" ")[0]:""},write:function(t){e.AC(t)},owner:e}),e.MaxHPText=ko.pureComputed(function(){return e.MaxHP()?"Max: "+e.MaxHP():e.HP()}),e.LevelAndCR=ko.pureComputed({read:function(){return e.Level()?e.Level():e.CR()?e.CR():void 0},write:function(t){e.Level()&&e.Level(t),e.CR()&&e.CR(t)}}),e.HP.subscribe(function(e){WORKSPACE.ViewModels.CombatViewModel.LoadTokens()}),e.CalculateHP=ko.pureComputed({read:function(){return e.HP()},write:function(t){for(var o=0,n=t.match(/[+\-]*(\.\d+|\d+(\.\d+)?)/g)||[];n.length;)o+=parseFloat(n.shift());e.MaxHP()||e.MaxHP(e.HP()),e.HP(o)},owner:e}),e.Load=function(t){if("Player"==t.ModelType)e.Initiative(t.Initiative),e.HP(t.HP),e.Level(t.Level),e.Size("M");else if("NPC"==t.ModelType){e.Size(t.Size),e.CR(t.CR);var o=t.Initiative||WORKSPACE.Helpers.Roll(1,20)+parseInt(t.DEXMOD);e.Initiative(o>=0?o:0);var n=(""+t.HP).split("("),a=[],r=0;if("object"==typeof n&&n.length>1){for(n=n[1].split(")"),a=n[0].match(/\d+d\d+/g),rollSplit=a[0].split("d"),i=0;i<rollSplit[0];i++)r+=parseInt(WORKSPACE.Helpers.Roll(1,rollSplit[1]));r+=parseInt(n[0].slice(a[0].length))||0}else r=parseInt(n[0]);var s=(""+t.HP).split("d");"object"==typeof s&&s.length>1?e.HP(r):e.HP(t.HP||r)}else e.Size("M");e.PositionTop(t.PositionTop||0),e.PositionLeft(t.PositionLeft||0),e.ZIndex(t.ZIndex||0),e.MaxHP(t.MaxHP||null),e.Id(t.Id||null),e.ModelType(t.ModelType),e.Name(t.Name||""),e.AC(t.AC),e.Skip(t.Skip||!1),e.Effects(t.Effects||[]),e.LatLng(t.LatLng||null),e.Token(t.Token||null),e.Angle(t.Angle||0)},e.AddEffect=function(){}},CombatViewModel=function(){var e=this;e.Selector=null,e.Interval=null,e.ActiveTab=ko.observable(0).extend({trackChange:!0}),e.CombatantList=ko.observableArray().extend({trackChange:!0}),e.Combatant=new CombatantModel,e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.GridWidth=ko.observable(),e.MapSlides=ko.observableArray().extend({trackChange:!0}),e.MapToAdd=ko.observable(),e.ShowGridLines=ko.observable(!0).extend({trackChange:!0}),e.AltGridColor=ko.observable(!1).extend({trackChange:!0}),e.ActiveMap=ko.observable("").extend({trackChange:!0}),e.ShowOutlines=ko.observable(!1).extend({trackChange:!0}),e.CustomIcons=ko.observableArray().extend({trackChange:!0}),e.TokenScale=ko.observable(1).extend({throttle:200,trackChange:!0}),e.TransmitMap=ko.observable(!1).extend({trackChange:!0}),e.GridCenter=ko.observable([0,0]).extend({trackChange:!0}),e.GridZoom=ko.observable(1).extend({trackChange:!0}),e.CombatantList.subscribe(function(t){e.LoadTokens()}),e.ShowOutlines.subscribe(function(t){e.LoadTokens()}),e.TokenScale.subscribe(function(t){t&&e.LoadTokens()}),e.LoadTokens=function(t){$.each(WORKSPACE.GridLayers,function(e,t){WORKSPACE.GridMap.removeLayer(t)});var o=WORKSPACE.TokenSize.M*e.TokenScale()+"px";o=o+" "+o,$("#grid-lines").css("background-size",o),$.each(e.CombatantList(),function(o,n){var a=null;if(n.Name()&&""!==n.Name()&&$.each(e.CustomIcons(),function(e,t){t.name==n.Name()&&(a=t.token)}),null===a)if(null===n.Token())a="Player"==n.ModelType()?"http://i.imgur.com/BF7DY3I.png":"http://i.imgur.com/dgZ2jjL.png",n.Token(a);else{a=n.Token();var r=!1;$.each(e.CustomIcons(),function(e,t){t.name==n.Name()&&(r=!0)}),r||e.CustomIcons.push({name:n.Name(),token:n.Token()})}var i=(n.HP()<=0?"dead ":"")+(e.ShowOutlines()?"outline "+n.ModelType():""),s=WORKSPACE.TokenSize[n.Size()]*e.TokenScale(),l=new L.icon({iconUrl:a,iconSize:[s,s],className:i});n.LatLng(!n.LatLng()||t?L.latLng(50,50):n.LatLng());var c=new L.marker(n.LatLng(),{draggable:"true",icon:l,title:n.Name(),alt:n.Name(),iconAngle:n.Angle()});c.bindPopup(n.Name(),{closeButton:!1,offset:L.point(0,38*e.TokenScale()),closeOnClick:!1,opacity:.7,autoPan:!1}),c.on("dragend",function(e){var t=e.target;n.LatLng(t.getLatLng())}),c.on("drag",function(e){c.setIconAngle(n.Angle())}),c.on("dblclick",function(e){var t=e.originalEvent;t.stopPropagation(),WORKSPACE.Helpers.ViewNPC(n.Id(),t)}),c.on("contextmenu",function(e){n.Angle((n.Angle()+45)%360),c.setIconAngle(n.Angle())}),c.on("mousedown",function(e){var t=e.originalEvent,o=WORKSPACE.DistanceFrom;t.stopPropagation(),t.which>1&&(o.left=$(t.srcElement).offset().left+$(t.srcElement).width()/2,o.top=$(t.srcElement).offset().top+$(t.srcElement).height()/2,WORKSPACE.ShowDistance=!0)}),c.on("mouseup",function(e){WORKSPACE.Helpers.DisableDistance(e.originalEvent)}),WORKSPACE.GridLayers.push(c),c.addTo(WORKSPACE.GridMap)})},e.ResetTokens=function(){e.LoadTokens(!0)},e.AddMap=function(t,o){e.MapSlides.push({Source:e.MapToAdd()}),e.MapToAdd("")},e.RemoveMap=function(t){e.MapSlides.remove(t)},e.ActiveMap.subscribe(function(e){""!==e&&WORKSPACE.Helpers.SwapMap(e)}),e.LoadMap=function(t,o){e.ActiveMap(o.currentTarget.src)},e.OrderedCombatantList=ko.pureComputed(function(){return e.CombatantList().sort(function(e,t){var o=parseInt(e.Initiative()||0),n=parseInt(t.Initiative()||0);return o<n?1:o>n?-1:o===n?e.Name()<t.Name()?-1:1:void 0})}),e.Difficulty=ko.pureComputed(function(){var t="Unknown",o=[0,0,0,0],n=[],a=[];if($.each(e.CombatantList(),function(e,t){"NPC"==t.ModelType()?a.push(t):"Player"==t.ModelType()&&n.push(t)}),!n.length)return t;if($.each(n,function(e,t){if(t.Level()||(o=null),null!==o)for(e=0;e<o.length;e++)o[e]+=WORKSPACE.XPPerLevel[t.Level()][e]}),null!==o){var r=a.length,i=0,s=0,l=0,c=0;c=r<2?0:r<3?1:r<7?2:r<11?3:r<15?4:5,WORKSPACE.ViewModels.PlayersViewModel.PlayersList().length<3&&c++,i=WORKSPACE.Multipliers[c],$.each(a,function(e,t){l+=parseInt(t.XP())}),s=l*i,t=s<o[0]?"Trivial":s<o[1]?"Easy":s<o[2]?"Medium":s<o[3]?"Hard":"Deadly"}return t}),e.AddCombatant=function(t){if(void 0===t)return void e.CombatantList.push(new CombatantModel);var o=!1,n=new CombatantModel;$.each(e.CombatantList(),function(e,n){n.Name()==t.Name&&(o=!0)}),o&&"NPC"!=t.ModelType||(n.Load(t),e.CombatantList.push(n))},e.RemoveCombatant=function(t){e.CombatantList.remove(t)},e.SetActiveTab=function(t){e.ActiveTab(t)},e.Load=function(t){e.ActiveTab(t.ActiveTab||0),e.Position({Left:t.Position.Left||0,Top:t.Position.Top||0}),e.IsMinimized(t.IsMinimized),e.ShowOutlines(t.ShowOutlines||!1),e.ShowGridLines(t.ShowGridLines||!1),e.AltGridColor(t.AltGridColor||!1),e.ActiveMap(t.ActiveMap||""),e.CustomIcons(t.CustomIcons||[]),e.TokenScale(t.TokenScale||1),e.GridCenter(t.GridCenter||[0,0]),e.GridZoom(t.GridZoom||1);var o=[];if(t.CombatantList.length>0){for(i=0;i<t.CombatantList.length;i++){var n=new CombatantModel;n.Load(t.CombatantList[i]),o.push(n)}e.CombatantList(o)}e.MapSlides(t.MapSlides||[])}},GameModel=function(e){var t=this;t.Name=ko.observable(e||""),t.Id=ko.pureComputed(function(){return"WORKSPACE-"+t.Name().toLowerCase()}),t.Name.subscribe(function(e){localStorage.removeItem(t.Id())},t,"beforeChange"),t.Name.subscribe(function(e){WORKSPACE.CurrentGame=t,WORKSPACE.ViewModels.GameViewModel.Save(),WORKSPACE.Save()},t)},GameViewModel=function(){var e=this;e.Selector=null,e.Position=ko.observable({Right:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!1).extend({trackChange:!0}),e.GameList=ko.observableArray([new GameModel("tmp")]),e.SelectedGame=ko.observable(),e.IsLoaded=ko.observable(!1),e.Load=function(t){e.Position({Left:t.Position.Left||0,Top:t.Position.Top||0}),e.IsMinimized(t.IsMinimized),e.LoadGameList(WORKSPACE.GameList),e.LoadSelectedGame(WORKSPACE.CurrentGame)},e.Save=function(){WORKSPACE.SupportsStorage()&&(WORKSPACE.DEBUG&&console.log("Game Model Saving"),localStorage.setItem("WORKSPACE",JSON.stringify({CurrentGame:ko.toJS(e.SelectedGame()),GameList:ko.toJS(e.GameList())})))},e.LoadGameList=function(t){var o=[];$.each(t,function(e,t){var n=new GameModel(t.Name);o.push(n)}),e.GameList(o)},e.LoadSelectedGame=function(t){void 0!==t&&$.each(e.GameList(),function(o,n){n.Name()==t.Name()&&e.SelectedGame(n)})},e.SelectedGame.subscribe(function(t){void 0!==t&&e.IsLoaded(!0)},null,"beforeChange"),e.SelectedGame.subscribe(function(t){e.IsLoaded()&&(e.Save(),location.reload())}),e.AddGame=function(){var t=new GameModel("Game"+(e.GameList().length+1));e.GameList.push(t),e.SelectedGame(t)},e.RemoveGame=function(){var t=e.SelectedGame();WORKSPACE.SupportsStorage()&&null!==localStorage.getItem(t.Id())&&(localStorage.removeItem(t.Id()),e.GameList.remove(t))}},ItemModel=function(){var e=this;e.Id=ko.observable(),e.Name=ko.observable().extend({trackChange:!0}),e.Text=ko.observable().extend({trackChange:!0}),e.IsRemoveVisible=ko.observable(!1),e.ShowRemove=function(){e.IsRemoveVisible(!0)},e.HideRemove=function(){e.IsRemoveVisible(!1)},e.Load=function(t,o){e.Id(t),e.Name(o.name),e.Text(o.text)}},LootViewModel=function(){var e=this;e.Selector=null,e.ActiveTab=ko.observable(0).extend({trackChange:!0}),e.CurrentItemId=0,e.SearchList=ko.observableArray().extend({trackChange:!0}),e.GenerateList=ko.observableArray().extend({trackChange:!0}),e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.Search=ko.observable("").extend({rateLimit:500,trackChange:!0}),e.CR=ko.observable(1),e.CRList=ko.observableArray(WORKSPACE.CRArray),e.Type=ko.observableArray(["Individual","Hoard"]),e.SelectedType=ko.observable(),e.RarityChance=ko.observable({Coin:80,Common:30,Uncommon:15,Rare:5,"Very Rare":2,Legendary:1}),e.Rarity=ko.observableArray(["Coin","Common","Uncommon","Rare","Very Rare","Legendary","Artifact","Unique"]),e.SelectedRarity=ko.observableArray(),e.SearchRarity=ko.observableArray(["ANY","Common","Uncommon","Rare","Very Rare","Legendary","Artifact","Unique"]),e.SelectedSearchRarity=ko.observableArray().extend({trackChange:!0}),e.Amount=ko.observable(1),e.AmountList=ko.observableArray([1,2,3,4,5,6,7,8,9,10]),e.SearchGrid=new ko.simpleGrid.viewModel({data:e.SearchList,type:"lootsearch",columns:[{headerText:"Name",rowText:"Name"},{headerText:"Attune",rowText:"Attune"},{headerText:"Rarity",rowText:"Rarity"},{headerText:"Id",rowText:"Id"}],pageSize:6}),e.GenerateGrid=new ko.simpleGrid.viewModel({data:e.GenerateList,columns:[{headerText:"Coin",rowText:"Coin"},{headerText:"Magic",rowText:"Magic"}],pageSize:6}),e.SelectedRarity.subscribe(function(e){}),e.SetActiveTab=function(t){e.ActiveTab(t)},e.Load=function(t){e.ActiveTab(t.ActiveTab||0),e.Search(t.Search||""),e.Amount(t.Amount||"1d6"),e.GenerateList(t.GenerateList||[]),e.SelectedType(t.SelectedType||"Individual"),e.SelectedRarity(t.SelectedRarity||"Coin"),e.SelectedSearchRarity(t.SelectedSearchRarity||"ANY"),e.Position({Left:t.Position.Left||0,Top:t.Position.Top||0}),e.IsMinimized(t.IsMinimized)},e.Search.subscribe(function(t){e.RunSearch()}),e.SelectedSearchRarity.subscribe(function(t){e.RunSearch()}),e.PickRandom=function(){e.SearchList().length>1?e.PickRandomAction():(e.RunSearch(),e.PickRandomAction())},e.PickRandomAction=function(){if(e.SearchList().length>1){var t=WORKSPACE.Helpers.Roll(1,e.SearchList().length)-1,o=e.SearchList()[t];e.SearchList.removeAll(),e.SearchGrid.currentPageIndex(0),e.SearchList.push(o)}},e.RunSearch=function(){if(""===e.Search()&&"ANY"==e.SelectedSearchRarity())return e.SearchList.removeAll(),void e.SearchGrid.currentPageIndex(0);e.SearchList.removeAll(),e.SearchGrid.currentPageIndex(0);var t=[];$.each(MAGIC,function(o,n){n.name.toLowerCase().indexOf(e.Search().toLowerCase())!==-1&&("ANY"==e.SelectedSearchRarity()||void 0!==n.rarity&&n.rarity.toLowerCase()==e.SelectedSearchRarity().toLowerCase())&&t.push(o)});var o=[];for(i=0;i<t.length;i++)o.push({Id:t[i],Name:MAGIC[t[i]].name,Rarity:MAGIC[t[i]].rarity,Attune:MAGIC[t[i]].attune});e.SearchList(o)},e.Generate=function(){e.GenerateList.removeAll(),e.GenerateGrid.currentPageIndex(0);var t=e.Amount().split("d");2!=t.length}},NPCModel=function(){var e=this;e.ModelType="NPC",e.Id=ko.observable().extend({trackChange:!0}),e.Name=ko.observable().extend({trackChange:!0}),e.Description=ko.observable().extend({trackChange:!0}),e.Size=ko.observable().extend({trackChange:!0}),e.Type=ko.observable().extend({trackChange:!0}),e.Alignment=ko.observable().extend({trackChange:!0}),e.AC=ko.observable().extend({trackChange:!0}),e.HP=ko.observable().extend({trackChange:!0}),e.Speed=ko.observable().extend({trackChange:!0}),e.STR=ko.observable().extend({trackChange:!0}),e.DEX=ko.observable().extend({trackChange:!0}),e.CON=ko.observable().extend({trackChange:!0}),e.INT=ko.observable().extend({trackChange:!0}),e.WIS=ko.observable().extend({trackChange:!0}),e.CHA=ko.observable().extend({trackChange:!0}),e.Skill=ko.observable().extend({trackChange:!0}),e.Resist=ko.observable().extend({trackChange:!0}),e.Senses=ko.observable().extend({trackChange:!0}),e.Passive=ko.observable().extend({trackChange:!0}),e.Languages=ko.observable().extend({trackChange:!0}),e.CR=ko.observable().extend({trackChange:!0}),e.Trait=ko.observableArray().extend({trackChange:!0}),e.Action=ko.observableArray().extend({trackChange:!0}),e.Immune=ko.observable().extend({trackChange:!0}),e.ConditionImmune=ko.observable().extend({trackChange:!0}),e.Spells=ko.observable().extend({trackChange:!0}),e.Legendary=ko.observableArray().extend({trackChange:!0}),e.Save=ko.observable().extend({trackChange:!0}),e.Source=ko.observable().extend({trackChange:!0}),e.Vulnerable=ko.observable().extend({trackChange:!0}),e.Reaction=ko.observableArray().extend({trackChange:!0}),e.IsRemoveVisible=ko.observable(!1),e.Similar=ko.observableArray(),e.SelectedSimilar=ko.observableArray().extend({trackChange:!0}),e.PopulateSimilar=function(){if(void 0===e.Id())return[{Id:0,Name:"None [0]",Cost:0}];var t=[];$.each(MONSTERS,function(o,n){if(e.Name()!=n.name){var a={Id:o,Name:n.name,Cost:0};a.Cost+=e.Name().levenstein(n.name),a.Cost+=5*e.Type().levenstein(n.type),a.Cost+=e.CR().levenstein(n.cr),a.Cost+=e.AC().levenstein(n.ac),a.Cost+=5*e.Alignment().levenstein(n.alignment),a.Cost+=e.HP().split(" ")[0].levenstein(n.hp.split(" ")[0]),t.push(a)}}),t.sort(function(e,t){return e.Cost<t.Cost?-1:1}),e.Similar(t.slice(1,11))},e.SelectedSimilar.subscribe(function(e){void 0!==e&&(WORKSPACE.NPCView.dialog("close"),WORKSPACE.NPCViewVM.Load(e.Id,MONSTERS[e.Id]),WORKSPACE.ViewModels.NPCsViewModel.CurrentNPCId=e.Id,WORKSPACE.NPCView.dialog("option","title",MONSTERS[e.Id].name),WORKSPACE.NPCView.dialog("open"),WORKSPACE.NPCViewVM.PopulateSimilar())}),e.ShowRemove=function(){e.IsRemoveVisible(!0)},e.HideRemove=function(){e.IsRemoveVisible(!1)},e.PassivePerception=ko.pureComputed(function(){return"passive perception "+e.Passive()}),e.TotalSenses=ko.pureComputed(function(){var t=e.Senses(),o=e.PassivePerception();return t&&o?t+"; "+o:t?t:o?o:null}),e.XP=ko.pureComputed(function(){return WORKSPACE.XPPerCR[e.CR()]}),e.Challenge=ko.pureComputed(function(){return e.CR()+" ("+e.XP()+" XP)"}),e.SizeText=ko.pureComputed(function(){switch(e.Size()){case"F":return"Fine";case"D":return"Diminutive";case"T":return"Tiny";case"S":return"Small";case"M":return"Medium";case"L":return"Large";case"H":return"Huge";case"G":return"Gargantuan";case"C":return"Colossal";default:return"(Unknown Size)"}}),e.BasicDescription=ko.pureComputed(function(){return e.SizeText()+" "+e.Type()+", "+e.Alignment()}),e.STRMOD=ko.pureComputed(function(){return e.MOD(e.STR())}),e.DEXMOD=ko.pureComputed(function(){return e.MOD(e.DEX())}),e.CONMOD=ko.pureComputed(function(){return e.MOD(e.CON())}),e.INTMOD=ko.pureComputed(function(){return e.MOD(e.INT())}),e.WISMOD=ko.pureComputed(function(){return e.MOD(e.WIS())}),e.CHAMOD=ko.pureComputed(function(){return e.MOD(e.CHA())}),e.MOD=function(e){var t=Math.floor((e-10)/2);return t>0?"+"+t:t},e.Load=function(t,o){e.Id(t),e.Name(o.name||""),e.Description(o.description||""),e.Size(o.size||""),e.Type(o.type||""),e.Alignment(o.alignment||""),e.AC(o.ac||""),e.HP(o.hp||""),e.Speed(o.speed||""),e.STR(o.str||""),e.DEX(o.dex||""),e.CON(o.con||""),e.INT(o.int||""),e.WIS(o.wis||""),e.CHA(o.cha||""),e.Skill(o.skill||""),e.Resist(o.resist||""),e.Senses(o.senses||""),e.Passive(o.passive||""),e.Languages(o.languages||""),e.CR(o.cr||""),e.Trait(o.trait||[]),e.Action(o.action||[]),e.Immune(o.immune||""),e.ConditionImmune(o.conditionImmune||""),e.Spells(o.spells||""),e.Legendary(o.legendary||[]),e.Save(o.save||""),e.Source(o.source||""),e.Vulnerable(o.vulnerable||""),e.Reaction(o.reaction||[])}},GroupModel=function(e){var t=this;t.NPCs=ko.observableArray().extend({trackChange:!0}),t.Title=ko.observable(e||"").extend({rateLimit:500,trackChange:!0}),t.Load=function(e){t.Title(e.Title||""),$.each(e.NPCs,function(e,o){t.AddNPC(o.Id)})},t.NPCsByCR=ko.pureComputed(function(){return t.NPCs().sort(function(e,t){var o=e.CR().split("/"),n=t.CR().split("/"),a=o.length>1?parseInt(o[0],10)/parseInt(o[1],10):parseInt(o[0]),r=n.length>1?parseInt(n[0],10)/parseInt(n[1],10):parseInt(n[0]);return a<r?-1:a>r?1:a===r?e.Name()<t.Name()?-1:1:void 0})}),t.Difficulty=ko.pureComputed(function(){var e="Unknown",o=[0,0,0,0];if(!WORKSPACE.ViewModels.PlayersViewModel.PlayersList().length)return e;if($.each(WORKSPACE.ViewModels.PlayersViewModel.PlayersList(),function(e,t){if(!t.Level())return void(o=null);for(e=0;e<o.length;e++)o[e]+=WORKSPACE.XPPerLevel[t.Level()][e]}),null!==o){var n=t.NPCs().length,a=0,r=0,i=0,s=0;s=n<2?0:n<3?1:n<7?2:n<11?3:n<15?4:5,WORKSPACE.ViewModels.PlayersViewModel.PlayersList().length<3&&s++,a=WORKSPACE.Multipliers[s],$.each(t.NPCs(),function(e,t){i+=parseInt(t.XP())}),r=i*a,e=r<o[0]?"Trivial":r<o[1]?"Easy":r<o[2]?"Medium":r<o[3]?"Hard":"Deadly"}return e}),t.AddNPC=function(e){var o=new NPCModel;o.Load(e,MONSTERS[e]),t.NPCs.push(o)},t.RemoveNPC=function(e){t.NPCs.remove(e)}},NPCsViewModel=function(){var e=this;e.Selector=null,e.ActiveTab=ko.observable(0).extend({trackChange:!0}),e.CurrentNPCId=0,e.Search=ko.observable("").extend({rateLimit:500}).extend({trackChange:!0}),e.Type=ko.observable("").extend({rateLimit:500}).extend({trackChange:!0}),e.CRList=ko.observableArray(WORKSPACE.CRArray),e.CR=ko.observable("").extend({rateLimit:500}).extend({trackChange:!0}),e.SearchList=ko.observableArray(),e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.GroupList=ko.observableArray([new GroupModel("Group1")]).extend({trackChange:!0}),e.SelectedGroup=ko.observable().extend({trackChange:!0}),e.SetActiveTab=function(t){e.ActiveTab(t)},e.Load=function(t){e.ActiveTab(t.ActiveTab||0),e.Position({Left:t.Position.Left||0,Top:t.Position.Top||0}),e.IsMinimized(t.IsMinimized),e.Search(t.Search||""),e.Type(t.Type||""),e.CR(t.CR||"");var o=[];t.GroupList.length>0&&($.each(t.GroupList,function(n,a){var r=t.GroupList[n],i=new GroupModel;i.Load(r),t.SelectedGroup.Title==r.Title&&e.SelectedGroup(i),o.push(i)}),e.GroupList(o))},e.SendCombat=function(){$.each(e.SelectedGroup().NPCs(),function(e,t){WORKSPACE.ViewModels.CombatViewModel.AddCombatant(ko.toJS(t))})},e.AddGroup=function(){var t=new GroupModel("Group"+(e.GroupList().length+1));e.GroupList.push(t),e.SelectedGroup(t)},e.RemoveGroup=function(t){1==e.GroupList().length&&e.GroupList.push(new GroupModel("Group1")),e.GroupList.remove(t)},e.SearchGrid=new ko.simpleGrid.viewModel({data:e.SearchList,type:"npcs",columns:[{headerText:"Id",rowText:"Id"},{headerText:"Name",rowText:"Name"},{headerText:"Type",rowText:"Type"},{headerText:"CR",rowText:"CR"}],pageSize:6}),e.Type.subscribe(function(t){e.RunSearch()}),e.CR.subscribe(function(t){e.RunSearch()}),e.Search.subscribe(function(t){e.RunSearch()}),e.RunSearch=function(){if(""===e.Search()&&""===e.Type()&&""===e.CR())return e.SearchList.removeAll(),void e.SearchGrid.currentPageIndex(0);e.SearchList.removeAll(),e.SearchGrid.currentPageIndex(0);var t=[];$.each(MONSTERS,function(o,n){""!==e.Search()&&n.name.toLowerCase().indexOf(e.Search().toLowerCase())===-1||""!==e.Type()&&n.type.toLowerCase().indexOf(e.Type().toLowerCase())===-1||""!==e.CR()&&n.cr!=e.CR()||t.push({Id:o,Name:n.name,Type:n.type,CR:n.cr})}),t.sort(function(e,t){var o=e.CR.split("/"),n=t.CR.split("/"),a=o.length>1?parseInt(o[0],10)/parseInt(o[1],10):parseInt(o[0]),r=n.length>1?parseInt(n[0],10)/parseInt(n[1],10):parseInt(n[0]);return a<r?-1:a>r?1:a===r?e.Name<t.Name?-1:1:void 0}),e.SearchList(t)}},PlayerModel=function(e,t,o,n,a,r){var i=this;i.ModelType="Player",i.Name=ko.observable(e||"").extend({trackChange:!0}),i.AC=ko.observable(t||"").extend({trackChange:!0}),i.Class=ko.observable(o||"").extend({trackChange:!0}),i.Passive=ko.observable(n||"").extend({trackChange:!0}),i.Level=ko.observable(a||"").extend({trackChange:!0}),i.XP=ko.observable(r||"").extend({trackChange:!0})},PlayersViewModel=function(){var e=this;e.Selector=null,e.PlayersList=ko.observableArray().extend({trackChange:!0}),e.Player=new PlayerModel,e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.SendCombat=function(){$.each(e.PlayersList(),function(e,t){WORKSPACE.ViewModels.CombatViewModel.AddCombatant(ko.toJS(t))})},e.AddPlayer=function(){e.PlayersList.push(new PlayerModel)},e.RemovePlayer=function(t){e.PlayersList.remove(t)},e.Load=function(t){e.Position({Left:t.Position.Left||0,Top:t.Position.Top||0}),e.IsMinimized(t.IsMinimized);var o=[];if(t.PlayersList.length>0){for(i=0;i<t.PlayersList.length;i++)o.push(new PlayerModel(t.PlayersList[i].Name,t.PlayersList[i].AC,t.PlayersList[i].Class,t.PlayersList[i].Passive,t.PlayersList[i].Level,t.PlayersList[i].XP));e.PlayersList(o)}}},RollModel=function(){var e=this;e.Amount=ko.observable(0).extend({trackChange:!0}),e.Dice=ko.observable(0).extend({trackChange:!0}),e.Modifier=ko.observable(0).extend({trackChange:!0}),e.Load=function(t){e.Amount(t.Amount||0),e.Dice(t.Dice||0),e.Modifier(t.Modifier||0)},e.String=ko.pureComputed(function(){return e.Amount()+"d"+e.Dice()+(e.Modifier>0)?" +"+e.Modifier():e.Modifier()<0?" "+e.Modifier():""})},RollViewModel=function(){var e=this;e.Selector=null,e.RollList=ko.observableArray().extend({trackChange:!0}),e.Selected=ko.observable().extend({trackChange:!0}),e.Result=ko.observable().extend({trackChange:!0}),e.ResultBreakdown=ko.observableArray().extend({trackChange:!0}),e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.MatchDiceSet=/(\-?\+?\d+d\d+)/gi,e.MatchDice=/(\d+)d(\d+)/i,e.MatchMod=/[+\-]*(\.\d+|\d+(\.\d+)?)/g,e.RollString=ko.observable("").extend({trackChange:!0}),e.BreakdownString=ko.pureComputed(function(){var t="",o=e.ResultBreakdown();return $.each(o,function(e,o){t+=o.String+"  ["+o.Rolls.toString()+"]\n"}),t}),e.RollList.subscribe(function(t){e.RollList().length>10&&e.RollList.shift()}),e.Selected.subscribe(function(t){void 0!==t&&(e.Result(""),e.ResultBreakdown.removeAll(),e.RollString(t))}),e.ExecuteRoll=function(){var t=0,o=0,n=null,r=null,i=null,l=e.RollString();if(e.MatchDiceSet.lastIndex=0,e.ResultBreakdown.removeAll(),e.Result(""),e.MatchDiceSet.test(l)!==!1){for(r=l.match(e.MatchDiceSet),s=0;s<r.length;s++){var c={String:r[s],Rolls:[]};for(n=r[s].match(e.MatchDice),a=0;a<n[1];a++){var d=WORKSPACE.Helpers.Roll(1,n[2]);c.Rolls.push(d),"-"==r[s][0]&&(d*=-1),t+=d}e.ResultBreakdown.push(c),l=l.replace(r[s],"")}if(e.MatchMod.lastIndex=0,e.MatchMod.test(l)!==!1){for(i=l.match(e.MatchMod);i.length;)o+=parseFloat(i.shift());e.ResultBreakdown.push({String:"Mod",Rolls:[o]})}e.Result(t+o),e.AddRoll(e.RollString())}},e.AddRoll=function(t){e.RollList().indexOf(t)===-1&&e.RollList.push(t)},e.RemoveRoll=function(t){e.RollList.remove(t)},e.Load=function(t){e.Position({Left:t.Position.Left||0,Top:t.Position.Top||0}),e.IsMinimized(t.IsMinimized),e.RollString(t.RollString||""),e.Result(t.Result||""),e.RollList(t.RollList||[])}},SaveViewModel=function(){var e=this;e.Running=ko.observable(0),e.Running.subscribe(function(t){WORKSPACE.DEBUG&&console.log("Saving"),WORKSPACE.Save(),e.Running(0)}),e.Run=function(){e.Running(e.Running()+1)}},SpellModel=function(){var e=this;e.Id=ko.observable(),e.Level=ko.observable().extend({trackChange:!0}),e.Name=ko.observable().extend({trackChange:!0}),e.Type=ko.observable().extend({trackChange:!0}),e.Cast=ko.observable().extend({trackChange:!0}),e.Range=ko.observable().extend({trackChange:!0}),e.Components=ko.observable().extend({trackChange:!0}),e.Materials=ko.observable().extend({trackChange:!0}),e.Duration=ko.observable().extend({trackChange:!0}),e.Description=ko.observable().extend({trackChange:!0}),e.Class=ko.observable().extend({trackChange:!0}),e.IsRemoveVisible=ko.observable(!1),e.MaterialsValue=ko.pureComputed(function(){return e.Materials()?"("+e.Materials()+")":""}),e.ShowRemove=function(){e.IsRemoveVisible(!0)},e.HideRemove=function(){e.IsRemoveVisible(!1)},e.Load=function(t,o){e.Id(t),e.Level(o.Level),e.Name(o.Name),e.Type(o.Type),e.Cast(o.Cast),e.Range(o.Range),e.Components(o.Components),e.Materials(o.Materials),e.Duration(o.Duration),e.Description(o.Description),e.Class(o.Class)}},SpellbookModel=function(e){var t=this;t.Spells=ko.observableArray().extend({trackChange:!0}),t.Title=ko.observable(e||"").extend({rateLimit:500,trackChange:!0}),t.ShowSlots=ko.observable(!0).extend({trackChange:!0}),t.SpellSlots=ko.observableArray([{Slots:[0,0,0,0]},{Slots:[0,0,0]},{Slots:[0,0,0]},{Slots:[0,0,0]},{Slots:[0,0,0]},{Slots:[0,0]},{Slots:[0,0]},{Slots:[0]},{Slots:[0]}]),t.SlotsUsed=ko.observableArray().extend({trackChange:!0}),t.Load=function(e){t.Title(e.Title||""),t.ShowSlots(e.ShowSlots||!1),t.SlotsUsed(e.SlotsUsed||[]),$.each(e.Spells,function(e,o){t.AddSpell(o.Id)})},t.ResetSlots=function(){t.SlotsUsed([])},t.SpellsByLevel=ko.pureComputed(function(){var e=t.Spells(),o=[],n=[];return 0===e.length?e:($.each(e,function(e,t){$.inArray(t.Level(),o)===-1&&o.push(t.Level())}),o.sort(),$.each(o,function(t,o){var a={Key:o,Spells:[]};$.each(e,function(e,t){t.Level()==o&&a.Spells.push(t)}),n.push(a)}),n)}),t.ToggleSlots=function(){t.ShowSlots(!t.ShowSlots())},t.AddSpell=function(e){var o=!1;if($.each(t.Spells(),function(t,n){n.Id()==e&&(o=!0)}),!o){var n=new SpellModel;n.Load(e,SPELLS[e]),t.Spells.push(n)}},t.RemoveSpell=function(e){t.Spells.remove(e)}},SpellsViewModel=function(){var e=this;e.Selector=null,e.ActiveTab=ko.observable(0).extend({trackChange:!0}),e.SearchList=ko.observableArray().extend({rateLimit:500}),e.Search=ko.observable("").extend({rateLimit:500,trackChange:!0}),e.Class=ko.observable("").extend({rateLimit:500,trackChange:!0}),e.Level=ko.observable().extend({rateLimit:500,trackChange:!0}),e.LevelList=ko.observableArray(["","Cantrip",1,2,3,4,5,6,7,8,9]),e.BookList=ko.observableArray([new SpellbookModel("Book1")]).extend({trackChange:!0}),e.SelectedBook=ko.observable().extend({trackChange:!0}),e.SelectedBookAddSpell=ko.observable(),e.Spellbook=ko.observable(),e.CurrentSpellId=0,e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.SearchGrid=new ko.simpleGrid.viewModel({data:e.SearchList,type:"spells",columns:[{headerText:"Id",rowText:"Id"},{headerText:"Level",rowText:"Level"},{headerText:"Name",rowText:"Name"}],pageSize:6}),e.AddBook=function(){var t=new SpellbookModel("Book"+(e.BookList().length+1));e.BookList.push(t),e.SelectedBook(t)},e.RemoveBook=function(t){1==e.BookList().length&&e.BookList.push(new SpellbookModel("Book1")),e.BookList.remove(t)},e.SetActiveTab=function(t){e.ActiveTab(t)},e.Load=function(t){e.ActiveTab(t.ActiveTab||0),e.Position({Left:t.Position.Left||0,Top:t.Position.Top||0}),e.IsMinimized(t.IsMinimized),e.Search(t.Search||""),e.Class(t.Class||""),e.Level(t.Level||"");var o=[];t.BookList.length>0&&($.each(t.BookList,function(n,a){var r=t.BookList[n],i=new SpellbookModel;i.Load(r),t.SelectedBook.Title==r.Title&&e.SelectedBook(i),o.push(i)}),e.BookList(o))},e.RunSearch=function(){e.SearchList.removeAll(),e.SearchGrid.currentPageIndex(0);var t="Cantrip"===e.Level()?"0":e.Level();if(""!==e.Search()||""!==e.Class()||""!==t){$.each(SPELLS,function(o,n){(""===e.Class()||""!==e.Class()&&n.Class.toLowerCase().indexOf(e.Class().toLowerCase())!==-1)&&(""===e.Search()||""!==e.Search()&&n.Name.toLowerCase().indexOf(e.Search().toLowerCase())!==-1)&&(""===t||""!==t&&n.Level==t)&&e.SearchList.push({Id:o,Level:SPELLS[o].Level,Name:SPELLS[o].Name,Data:SPELLS[o]})}),e.SearchList.sort(function(e,t){return e.Level<t.Level?-1:e.Level>t.Level?1:e.Level==t.Level?e.Name<t.Name?-1:1:void 0})}},e.Search.subscribe(function(t){e.RunSearch()},this),e.Class.subscribe(function(t){e.RunSearch()},this),e.Level.subscribe(function(t){e.RunSearch()},this)},indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB||window.shimIndexedDB;open.onupgradeneeded=function(){var e=open.result,t=e.createObjectStore("ViewModels",{keyPath:"id"});t.objectStoreNames.contains("Combat")||t.createIndex("Combat"),t.objectStoreNames.contains("Game")||t.createIndex("Game"),t.objectStoreNames.contains("Loot")||t.createIndex("Loot"),t.objectStoreNames.contains("NPCs")||t.createIndex("NPCs"),t.objectStoreNames.contains("Players")||t.createIndex("Players"),t.objectStoreNames.contains("Roll")||t.createIndex("Roll"),t.objectStoreNames.contains("Spells")||t.createIndex("Spells")},open.onsuccess=function(){var e=open.result,t=e.transaction("ViewModels","readwrite"),o=t.objectStore("ViewModels");o.index("NameIndex");getJohn.onsuccess=function(){console.log(getJohn.result.name.first);
},getBob.onsuccess=function(){console.log(getBob.result.name.first)},t.oncomplete=function(){e.close()}},open.onerror=function(e){};