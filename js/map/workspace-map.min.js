var WORKSPACE={VIEW:1,DEBUG:!1,ViewModels:{},GridLayers:[],GridImageOverlay:null,PreviousMapImage:null,IsLoaded:!1,ShowDistance:!1,TokenSize:{T:12,S:50,M:50,L:100,H:150,G:250,C:400},CRArray:["","0","1/8","1/4","1/2",1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],XPPerLevel:{1:[25,50,75,100],2:[50,100,150,200],3:[75,150,225,400],4:[125,250,375,500],5:[250,500,750,1100],6:[300,600,900,1400],7:[350,750,1100,1700],8:[450,900,1400,2100],9:[550,1100,1600,2400],10:[600,1200,1900,2800],11:[800,1600,2400,3600],12:[1e3,2e3,3e3,4500],13:[1100,2200,3400,5100],14:[1250,2500,3800,5700],15:[1400,2800,4300,6400],16:[1600,3200,4800,7200],17:[2e3,3900,5900,8800],18:[2100,4200,6300,9500],19:[2400,4900,7300,10900],20:[2800,5700,8500,12700]},XPPerCR:{0:10,"1/8":25,"1/4":50,"1/2":100,1:200,2:450,3:700,4:1100,5:1800,6:2300,7:2900,8:3900,9:5e3,10:5900,11:7200,12:8400,13:1e4,14:11500,15:13e3,16:15e3,17:18e3,18:2e4,19:22e3,20:25e3,21:33e3,22:41e3,23:5e4,24:62e3,25:75e3,26:9e4,27:105e3,28:12e4,29:135e3,30:155e3},Multipliers:[1,1.5,2,2.5,3,4,5],DistanceFrom:{top:0,left:0}};WORKSPACE.Helpers={DrawLights:function(){if(WORKSPACE.ViewModels.CombatViewModel.ShowDarkness()){var e=$("#grid-light"),t=e[0].getContext("2d"),o=0,i=1,n=600*WORKSPACE.ViewModels.CombatViewModel.TokenScale(),a=2*n,r="rgba(0,0,0,"+(1-o)+")",s=WORKSPACE.GridMap.getSize();t.clearRect(0,0,e[0].width,e[0].height),e.css("top",-a+"px"),e.css("left",-a+"px"),e.attr("width",s.x+2*a+"px"),e.attr("height",s.y+2*a+"px"),$(".leaflet-marker-icon").each(function(e,o){var s=$(o);if(s.hasClass("player")){var p=s.offset(),l=p.left+s.width()/2+a,h=p.top+s.height()/2+a,c=t.createRadialGradient(l,h,0,l,h,n);c.addColorStop(1,"rgba(0,0,0,"+(1-i)+")"),c.addColorStop(0,r),t.fillStyle=c,t.fillRect(l-n,h-n,l+n,h+n)}}),t.fillStyle=r,t.globalCompositeOperation="xor",t.fillRect(0,0,s.x+2*a,s.y+2*a)}},DisableDistance:function(e){if(e.which>1){var t=$("#grid-canvas")[0],o=t.getContext("2d");WORKSPACE.ShowDistance=!1,o.clearRect(0,0,t.width,t.height)}},DrawDistance:function(e){if(WORKSPACE.ShowDistance){var t=$("#grid-canvas"),o={left:WORKSPACE.DistanceFrom.left-t.offset().left,top:WORKSPACE.DistanceFrom.top-t.offset().top},i={left:e.pageX-t.offset().left,top:e.pageY-t.offset().top},n=t[0].getContext("2d"),a=o.left,r=o.top,s=i.left,p=i.top,l=0;n.clearRect(0,0,t[0].width,t[0].height),l=WORKSPACE.Helpers.DrawLabel(n,{x:a,y:r},{x:s,y:p},"center","5"),l>2&&(n.setLineDash([5,5]),n.beginPath(),n.moveTo(a,r),n.lineTo(s,p),n.strokeStyle="red",n.stroke())}},DrawLabel:function(e,t,o,i,n){i||(i="center"),n||(n=0);var a,r,s,p=o.x-t.x,l=o.y-t.y,h=Math.sqrt(p*p+l*l),c=0,f=Math.atan2(l,p);if((f<-Math.PI/2||f>Math.PI/2)&&(a=t,t=o,o=a,p*=-1,l*=-1,f-=Math.PI),"center"==i)a=t,r=.5;else{var d="left"==i;a=d?t:o,r=n/Math.sqrt(p*p+l*l)*(d?1:-1)}return e.font="14px Arial",c=(h/50*5).toFixed(1),s=c+" ft",c>2&&(e.save(),e.textAlign=i,e.translate(a.x+p*r,a.y+l*r),e.rotate(Math.atan2(l,p)),e.fillStyle="red",e.fillText(s,0,-5),e.restore()),c},SwapMap:function(e){if(WORKSPACE.PreviousMapImage!=e){WORKSPACE.PreviousMapImage=e;var t=new Image;t.onload=function(){var e=t.height,o=t.width,i=o/e,n=[[0,0],[100,100*i]];WORKSPACE.GridImageOverlay&&WORKSPACE.GridMap.removeLayer(WORKSPACE.GridImageOverlay),WORKSPACE.GridImageOverlay=new L.imageOverlay(t.src,n),WORKSPACE.GridImageOverlay.addTo(WORKSPACE.GridMap),WORKSPACE.GridMap.fitBounds(n)},t.src=e}},Throttle:function(e,t){var o=!1;return function(){o||(e.call(),o=!0,setTimeout(function(){o=!1},t))}}},WORKSPACE.Shim=function(){L.Map=L.Map.extend({openPopup:function(e,t,o){if(!(e instanceof L.Popup)){var i=e;e=new L.Popup(o).setContent(i)}return t&&e.setLatLng(t),this.hasLayer(e)?this:(this._popup=e,this.addLayer(e))},closePopup:function(e){return e&&e!==this._popup||(e=this._popup,this._popup=null),e&&(this.removeLayer(e),e._isOpen=!1),this},bindPopup:function(e,t){var o=L.point(this.options.icon.options.popupAnchor||[0,0]);return o=o.add(L.Popup.prototype.options.offset),t&&t.offset&&(o=o.add(t.offset)),t=L.extend({offset:o},t),this._popupHandlersAdded||(this.on("click",this.togglePopup,this).on("remove",this.closePopup,this).on("move",this._movePopup,this),this._popupHandlersAdded=!0),e instanceof L.Popup?(L.setOptions(e,t),this._popup=e,e._source=this):this._popup=new L.Popup(t,this).setContent(e),this}}),WORKSPACE.GridMap=new L.map("grid-map",{crs:L.CRS.Simple,minZoom:1,maxZoom:7,attributionControl:!1,zoomControl:!1});var e=WORKSPACE.GridMap;e.on("contextmenu",function(e){}),e.on("mousemove",function(e){WORKSPACE.Helpers.DrawDistance(e.originalEvent)}),e.on("mouseup",function(e){WORKSPACE.Helpers.DisableDistance(e.originalEvent)}),$(document).on("mouseup",function(e){WORKSPACE.Helpers.DisableDistance(e)}),e.on("move",function(e){var t=$("#grid-lines"),o=$(".leaflet-image-layer");o[0]&&(t.css("transform",o[0].style.transform),t.css("width",o.width()),t.css("height",o.height()),WORKSPACE.Helpers.DrawLights())}),e.on("mousedown",function(e){var t=e.originalEvent,o=WORKSPACE.DistanceFrom;t.stopPropagation(),t.which>1&&(o.left=t.pageX,o.top=t.pageY,WORKSPACE.ShowDistance=!0)}),e.on("load",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("viewreset",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("moveend",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("zoomend",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("zoomlevelschange",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("zoomlevelschange",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("layeradd",function(e){WORKSPACE.Helpers.DrawLights()}),e.on("dragend",function(e){WORKSPACE.Helpers.DrawLights()}),$("#grid-lines").appendTo($(".leaflet-map-pane"))};