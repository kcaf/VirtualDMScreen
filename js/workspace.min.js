var WORKSPACE={DEBUG:!1,Clicked:!1,PanelList:[],Alerted:!1,ColumnCount:3,LargeColumnWidth:0,ViewModels:{},GridLayers:[],GridImageOverlay:null,CurrentGridImage:null,Windows:[],LastGridHash:null,MinVal:0,MaxVal:0,IsLoaded:!1,ShowDistance:!1,CurrentGame:null,GameList:[],TokenSize:{T:12,S:50,M:50,L:100,H:150,G:250,C:400},CRArray:["","0","1/8","1/4","1/2",1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],XPPerLevel:{1:[25,50,75,100],2:[50,100,150,200],3:[75,150,225,400],4:[125,250,375,500],5:[250,500,750,1100],6:[300,600,900,1400],7:[350,750,1100,1700],8:[450,900,1400,2100],9:[550,1100,1600,2400],10:[600,1200,1900,2800],11:[800,1600,2400,3600],12:[1e3,2e3,3e3,4500],13:[1100,2200,3400,5100],14:[1250,2500,3800,5700],15:[1400,2800,4300,6400],16:[1600,3200,4800,7200],17:[2e3,3900,5900,8800],18:[2100,4200,6300,9500],19:[2400,4900,7300,10900],20:[2800,5700,8500,12700]},XPPerCR:{0:10,"1/8":25,"1/4":50,"1/2":100,1:200,2:450,3:700,4:1100,5:1800,6:2300,7:2900,8:3900,9:5e3,10:5900,11:7200,12:8400,13:1e4,14:11500,15:13e3,16:15e3,17:18e3,18:2e4,19:22e3,20:25e3,21:33e3,22:41e3,23:5e4,24:62e3,25:75e3,26:9e4,27:105e3,28:12e4,29:135e3,30:155e3},Multipliers:[1,1.5,2,2.5,3,4,5],DefaultPanels:["Combat","Players","Spells","Loot","NPCs","Game","Roll","Grid"],DistanceFrom:{top:0,left:0},DialogSize:{PlayersViewModel:{Width:"26vw",Height:"auto"},CombatViewModel:{Width:"30vw",Height:"auto"},RollViewModel:{Width:"215px",Height:"auto"},GameViewModel:{Width:"15vw",Height:"auto"},Default:{Width:"22vw",Height:"auto"}},Init:function(){WORKSPACE.DEBUG&&console.log("Init"),WORKSPACE.SaveViewModel=new SaveViewModel,WORKSPACE.Load(),WORKSPACE.InitDraw()},SupportsStorage:function(){var e,o=new Date;try{return localStorage.setItem(o,o),e=localStorage.getItem(o)==o,localStorage.removeItem(o),e&&localStorage}catch(e){if(!WORKSPACE.Alerted){var i="Your browser does not support Local File Web Storage.\nSession data will not be saved.";alert(i),WORKSPACE.Alerted=!0}return!1}},InitDraw:function(){WORKSPACE.DEBUG&&console.log("Add Elements"),$.each(WORKSPACE.PanelList,function(e,o){$.each(o,function(e,o){var i=o,t=i.title+"ViewModel",a="."+t.toLowerCase()+"-inc";"function"==typeof window[t]&&(ko.applyBindings(WORKSPACE.ViewModels[t],$(a)[0]),WORKSPACE.ViewModels[t].Selector=a);var n=WORKSPACE.ViewModels[t],l=$(a).dialog({autoOpen:!0,title:i.title,width:WORKSPACE.DialogSize[t]?WORKSPACE.DialogSize[t].Width:WORKSPACE.DialogSize.Default.Width,resizable:"CombatViewModel"==t,modal:!1}).dialogExtend({closable:!1,minimizable:!0,collapsable:!1,dblclick:"maximize"}).on("dialogdragstop",function(e,o){"object"==typeof n&&WORKSPACE.ViewModels[t].Position({Left:o.position.left,Top:o.position.top})}).bind("dialogextendminimize",function(e){"object"==typeof n&&WORKSPACE.ViewModels[t].IsMinimized(!0)}).bind("dialogextendrestore",function(e){"object"==typeof n&&WORKSPACE.ViewModels[t].IsMinimized(!1)});WORKSPACE.Windows.push({ViewModel:n,Element:l}),"object"==typeof n&&($(a).parent().css("left",n.Position().Left),$(a).parent().css("top",n.Position().Top),n.IsMinimized()&&l.dialogExtend("minimize"))})}),$(".lootviewmodel-inc").tabs({active:WORKSPACE.ViewModels.LootViewModel.ActiveTab()}),$(".spellsviewmodel-inc").tabs({active:WORKSPACE.ViewModels.SpellsViewModel.ActiveTab()}),$(".npcsviewmodel-inc").tabs({active:WORKSPACE.ViewModels.NPCsViewModel.ActiveTab()}),$(".combatviewmodel-inc").tabs({active:WORKSPACE.ViewModels.CombatViewModel.ActiveTab()}),$(".loot-rarity").chosen({width:"100%"}),WORKSPACE.SpellView=$("#SpellView").dialog({autoOpen:!1,width:"40vw",resizable:!0,height:"auto",modal:!0,dialogClass:"view-title",buttons:{"Add to Spellbook":function(){$(this).dialog("close"),WORKSPACE.Spellbooks.dialog("open")},Close:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.ItemView=$("#ItemView").dialog({autoOpen:!1,resizable:!0,modal:!0,width:"auto",dialogClass:"view-title",buttons:{Close:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.NPCView=$("#NPCView").dialog({autoOpen:!1,resizable:!0,modal:!0,dialogClass:"view-title",width:"760px",buttons:{"Add to Group":function(){WORKSPACE.NPCGroups.dialog("open")},"Send to Combat":function(){var e=new NPCModel,o=WORKSPACE.ViewModels.NPCsViewModel.CurrentNPCId;e.Load(o,MONSTERS[o]),WORKSPACE.ViewModels.CombatViewModel.AddCombatant(ko.toJS(e))},Close:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.NPCGroups=$("#NPCGroups").dialog({autoOpen:!1,modal:!0,buttons:{Confirm:function(){var e=WORKSPACE.ViewModels.NPCsViewModel;e.SelectedGroup().AddNPC(e.CurrentNPCId),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.Spellbooks=$("#Spellbooks").dialog({autoOpen:!1,modal:!0,buttons:{Confirm:function(){var e=WORKSPACE.ViewModels.SpellsViewModel;e.SelectedBook().AddSpell(e.CurrentSpellId),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.RenameBook=$("#RenameBook").dialog({autoOpen:!1,modal:!0,buttons:{Done:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.RenameGroup=$("#RenameGroup").dialog({autoOpen:!1,modal:!0,buttons:{Done:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.RenameGame=$("#RenameGame").dialog({autoOpen:!1,modal:!0,buttons:{Done:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.ResizeGridOrig="",WORKSPACE.ResizeGrid=function(e){var o=$(".combatviewmodel-inc"),i=$(".combatviewmodel-inc > .ui-tabs-nav"),t=o.height()-i.height()-12,a=o.width();$("#grid-map").css("height",t+"px"),$("#grid-canvas").attr("height",t+1),$("#grid-canvas").attr("width",a+6),WORKSPACE.GridMap&&e&&WORKSPACE.GridMap.invalidateSize()},WORKSPACE.ResizeGrid(),$(".combatviewmodel-inc").on("dialogresize",function(e,o){WORKSPACE.ResizeGrid(!0)}).on("dialogextendbeforeMaximize",function(e){var o=$("#GridTab"),i=o.parent();WORKSPACE.ResizeGridOrig=i.height()+i.offset().top-o.offset().top+"px"}).on("dialogextendmaximize",function(e){WORKSPACE.ResizeGrid(!0)}).on("dialogextendrestore",function(e){$("#grid-map").css("height",WORKSPACE.ResizeGridOrig),WORKSPACE.ResizeGrid(!0)}),WORKSPACE.SpellViewVM=new SpellModel,WORKSPACE.ItemViewVM=new ItemModel,WORKSPACE.NPCViewVM=new NPCModel,ko.applyBindings(WORKSPACE.SpellViewVM,$("#SpellView")[0]),ko.applyBindings(WORKSPACE.ItemViewVM,$("#ItemView")[0]),ko.applyBindings(WORKSPACE.NPCViewVM,$("#NPCView")[0]),ko.applyBindings(WORKSPACE.ViewModels.SpellsViewModel,$("#Spellbooks")[0]),ko.applyBindings(WORKSPACE.ViewModels.SpellsViewModel,$("#RenameBook")[0]),ko.applyBindings(WORKSPACE.ViewModels.NPCsViewModel,$("#NPCGroups")[0]),ko.applyBindings(WORKSPACE.ViewModels.NPCsViewModel,$("#RenameGroup")[0]),ko.applyBindings(WORKSPACE.ViewModels.GameViewModel,$("#RenameGame")[0]),L.Map=L.Map.extend({openPopup:function(e,o,i){if(!(e instanceof L.Popup)){var t=e;e=new L.Popup(i).setContent(t)}return o&&e.setLatLng(o),this.hasLayer(e)?this:(this._popup=e,this.addLayer(e))},closePopup:function(e){return e&&e!==this._popup||(e=this._popup,this._popup=null),e&&(this.removeLayer(e),e._isOpen=!1),this},bindPopup:function(e,o){var i=L.point(this.options.icon.options.popupAnchor||[0,0]);return i=i.add(L.Popup.prototype.options.offset),o&&o.offset&&(i=i.add(o.offset)),o=L.extend({offset:i},o),this._popupHandlersAdded||(this.on("click",this.togglePopup,this).on("remove",this.closePopup,this).on("move",this._movePopup,this),this._popupHandlersAdded=!0),e instanceof L.Popup?(L.setOptions(e,o),this._popup=e,e._source=this):this._popup=new L.Popup(o,this).setContent(e),this}}),WORKSPACE.GridMap=new L.map("grid-map",{crs:L.CRS.Simple,minZoom:1,maxZoom:7,attributionControl:!1}),WORKSPACE.GridMap.on("contextmenu",function(e){}),WORKSPACE.GridMap.on("mousemove",function(e){WORKSPACE.Helpers.DrawDistance(e.originalEvent)}),WORKSPACE.GridMap.on("mouseup",function(e){WORKSPACE.Helpers.DisableDistance(e.originalEvent)}),$(document).on("mouseup",function(e){WORKSPACE.Helpers.DisableDistance(e)}),WORKSPACE.GridMap.on("move",function(e){var o=$("#grid-lines"),i=$(".leaflet-image-layer");o&&i&&(o.css("transform",i[0].style.transform),o.css("width",i.width()),o.css("height",i.height()))}),WORKSPACE.GridMap.on("zoomend",function(e){WORKSPACE.ViewModels.CombatViewModel.GridZoom(WORKSPACE.GridMap.getZoom())}),WORKSPACE.GridMap.on("moveend",function(e){WORKSPACE.ViewModels.CombatViewModel.GridCenter(WORKSPACE.GridMap.getCenter())}),WORKSPACE.GridMap.on("mousedown",function(e){var o=e.originalEvent,i=WORKSPACE.DistanceFrom;o.stopPropagation(),o.which>1&&(i.left=o.pageX,i.top=o.pageY,WORKSPACE.ShowDistance=!0)}),$("#grid-lines").appendTo($(".leaflet-map-pane")),WORKSPACE.ViewModels.CombatViewModel.LoadTokens(),$("#token-scale").slider({range:"min",value:1,min:.5,step:.1,max:3,slide:function(e,o){WORKSPACE.ViewModels.CombatViewModel.TokenScale(o.value)}}),WORKSPACE.HideOverlay(),WORKSPACE.IsLoaded=!0,WORKSPACE.Debug&&console.log("> Workspace Loaded"),WORKSPACE.ViewModels.GameViewModel.Save()},HideOverlay:function(){$("#overlay").fadeOut()},LoadDefaultData:function(){WORKSPACE.DEBUG&&console.log("> Default Data"),WORKSPACE.CurrentGame=new GameModel("Game1"),WORKSPACE.GameList=[ko.toJS(WORKSPACE.CurrentGame)],WORKSPACE.PanelList=[];var e=0;for(i=0;i<WORKSPACE.DefaultPanels.length;i++)void 0===WORKSPACE.PanelList[e]&&(WORKSPACE.PanelList[e]=[]),WORKSPACE.PanelList[e].push(new Panel(WORKSPACE.DefaultPanels[i])),e++,e>WORKSPACE.ColumnCount-1&&(e=0);WORKSPACE.ViewModels.GameViewModel.LoadGameList(WORKSPACE.GameList),WORKSPACE.ViewModels.GameViewModel.LoadSelectedGame(WORKSPACE.CurrentGame)},LoadPanelOrder:function(e){for(WORKSPACE.DEBUG&&console.log("> Panel Order"),c=0;c<e.length;c++)for(WORKSPACE.PanelList.push([]),i=0;i<e[c].length;i++)WORKSPACE.PanelList[c].push(new Panel(e[c][i]))},LoadViewModels:function(e){WORKSPACE.DEBUG&&console.log("> View Models...");var o=new GameModel(e.Name);WORKSPACE.CurrentGame=o;var t=JSON.parse(localStorage.getItem(o.Id()));if(null===t){WORKSPACE.PanelList=[];var a=0;for(i=0;i<WORKSPACE.DefaultPanels.length;i++)void 0===WORKSPACE.PanelList[a]&&(WORKSPACE.PanelList[a]=[]),WORKSPACE.PanelList[a].push(new Panel(WORKSPACE.DefaultPanels[i])),a++,a>WORKSPACE.ColumnCount-1&&(a=0);WORKSPACE.ViewModels.GameViewModel.LoadGameList(WORKSPACE.GameList),WORKSPACE.ViewModels.GameViewModel.LoadSelectedGame(o)}else $.each(t.ViewModels,function(e,o){WORKSPACE.DEBUG&&console.log("> > "+o.Key),WORKSPACE.ViewModels[o.Key].Load(o.ViewModel)})},Load:function(){if(WORKSPACE.DEBUG&&console.log("Loading..."),WORKSPACE.SupportsStorage()){var e=JSON.parse(localStorage.getItem("WORKSPACE"));e?(WORKSPACE.LoadDefaultData(),void 0!==e.GameList&&void 0!==e.CurrentGame&&""!==e.CurrentGame.Id&&""!==e.CurrentGame.Name&&(WORKSPACE.GameList=e.GameList,WORKSPACE.LoadViewModels(e.CurrentGame))):WORKSPACE.LoadDefaultData()}else WORKSPACE.LoadDefaultData()},Save:function(){if(WORKSPACE.IsLoaded&&WORKSPACE.SupportsStorage()){WORKSPACE.DEBUG&&console.log("Saving");var e=[];$.each(WORKSPACE.ViewModels,function(o,i){e.push({Key:o,ViewModel:ko.toJS(i)})}),localStorage.setItem(WORKSPACE.CurrentGame.Id(),JSON.stringify({ViewModels:e})),WORKSPACE.CacheSave=e}},Clear:function(){WORKSPACE.SupportsStorage()&&localStorage.removeItem("WORKSPACE")}};WORKSPACE.Helpers={SaveCombatVM:function(){if(WORKSPACE.ViewModels.CombatViewModel.TransmitMap()){var e=ko.toJSON(WORKSPACE.ViewModels.CombatViewModel),o=e.hashCode();WORKSPACE.LastGridHash!=o&&(localStorage.setItem("MAPVIEW-Hash",o),localStorage.setItem("MAPVIEW-ViewModel",e),WORKSPACE.LastGridHash=o)}},DisableDistance:function(e){if(e.which>1){var o=$("#grid-canvas")[0],i=o.getContext("2d");WORKSPACE.ShowDistance=!1,i.clearRect(0,0,o.width,o.height)}},DrawDistance:function(e){if(WORKSPACE.ShowDistance){var o=$("#grid-canvas"),i={left:WORKSPACE.DistanceFrom.left-o.offset().left,top:WORKSPACE.DistanceFrom.top-o.offset().top},t={left:e.pageX-o.offset().left,top:e.pageY-o.offset().top},a=o[0].getContext("2d"),n=i.left,l=i.top,s=t.left,d=t.top,r=0;a.clearRect(0,0,o[0].width,o[0].height),r=WORKSPACE.Helpers.DrawLabel(a,{x:n,y:l},{x:s,y:d},"center","5"),r>2&&(a.setLineDash([5,5]),a.beginPath(),a.moveTo(n,l),a.lineTo(s,d),a.strokeStyle="red",a.stroke())}},DrawLabel:function(e,o,i,t,a){t||(t="center"),a||(a=0);var n,l,s,d,r=i.x-o.x,C=i.y-o.y,S=Math.sqrt(r*r+C*C),p=0,P=Math.atan2(C,r);if((P<-Math.PI/2||P>Math.PI/2)&&(n=o,o=i,i=n,r*=-1,C*=-1,P-=Math.PI),"center"==t)n=o,l=.5;else{var c="left"==t;n=c?o:i,l=a/Math.sqrt(r*r+C*C)*(c?1:-1)}return e.font="14px Arial",s=50*WORKSPACE.ViewModels.CombatViewModel.TokenScale(),p=(S/s*5).toFixed(1),d=p+" ft",p>2&&(e.save(),e.textAlign=t,e.translate(n.x+r*l,n.y+C*l),e.rotate(Math.atan2(C,r)),e.fillStyle="red",e.fillText(d,0,-5),e.restore()),p},SwapMap:function(e){WORKSPACE.CurrentGridImage=e;var o=new Image;o.onload=function(){var e=o.height,i=o.width,t=i/e,a=[[0,0],[100,100*t]];WORKSPACE.GridImageOverlay&&WORKSPACE.GridMap.removeLayer(WORKSPACE.GridImageOverlay),WORKSPACE.GridImageOverlay=new L.imageOverlay(o.src,a),WORKSPACE.GridImageOverlay.addTo(WORKSPACE.GridMap),WORKSPACE.GridMap.fitBounds(a)},o.src=e},TextFix:function(e){$(e).css({height:"auto","overflow-y":"hidden"}).height(e.scrollHeight)},Roll:function(e,o){return Math.floor(Math.random()*parseInt(o)+parseInt(e))},AddNPC:function(e,o){WORKSPACE.ViewModels.NPCsViewModel.CurrentNPCId=e.Id,WORKSPACE.NPCGroups.dialog("open")},AddSpell:function(e,o){WORKSPACE.ViewModels.SpellsViewModel.CurrentSpellId=e.Id,WORKSPACE.Spellbooks.dialog("open")},ViewSpell:function(e,o){WORKSPACE.SpellViewVM.Load(e,SPELLS[e]),WORKSPACE.ViewModels.SpellsViewModel.CurrentSpellId=e,WORKSPACE.SpellView.dialog("option","title",SPELLS[e].Name),WORKSPACE.SpellView.dialog("open")},ViewItem:function(e,o){WORKSPACE.ItemViewVM.Load(e,MAGIC[e]),WORKSPACE.ViewModels.LootViewModel.CurrentItemId=e,WORKSPACE.ItemView.dialog("option","title",MAGIC[e].name),WORKSPACE.ItemView.dialog("open")},ViewNPC:function(e,o){WORKSPACE.NPCViewVM.Load(e,MONSTERS[e]),WORKSPACE.ViewModels.NPCsViewModel.CurrentNPCId=e,WORKSPACE.NPCView.dialog("option","title",MONSTERS[e].name),WORKSPACE.NPCView.dialog("open"),WORKSPACE.NPCViewVM.PopulateSimilar()},RenameBook:function(e){WORKSPACE.RenameBook.dialog("open")},RenameGroup:function(e){WORKSPACE.RenameGroup.dialog("open")},RenameGame:function(e){WORKSPACE.RenameGame.dialog("open")},Throttle:function(e,o){var i=!1;return function(){i||(e.call(),i=!0,setTimeout(function(){i=!1},o))}}};var Panel=function(e,o,i,t){this.title=e,this.contents=o,this.position=i;var a=t,n="";$.each(a,function(e,o){n+=e+":"+o+";"}),this.style=n;var l=this.title+"ViewModel";"function"==typeof window[l]&&(WORKSPACE.ViewModels[l]=new window[l])};$(function(){var e=WORKSPACE.Helpers.Throttle(WORKSPACE.Save,400),o=WORKSPACE.Helpers.Throttle(WORKSPACE.Helpers.SaveCombatVM,100);String.prototype.hashCode=function(){var e=0;if(0==this.length)return e;for(i=0;i<this.length;i++)char=this.charCodeAt(i),e=(e<<5)-e+char,e&=e;return e},String.prototype.levenstein=function(e){var o,i,t=this,a=e+"",n=[],l=Math.min;if(!t||!a)return(a||t).length;for(o=0;o<=a.length;n[o]=[o++]);for(i=0;i<=t.length;n[0][i]=i++);for(o=1;o<=a.length;o++)for(i=1;i<=t.length;i++)n[o][i]=a.charAt(o-1)==t.charAt(i-1)?n[o-1][i-1]:n[o][i]=l(n[o-1][i-1]+1,l(n[o][i-1]+1,n[o-1][i]+1));return n[a.length][t.length]},ko.extenders.defaultIfNull=function(e,o){var i=ko.computed({read:e,write:function(i){e(i?i:o)}});return i(e()),i},ko.extenders.trackChange=function(i,t){return t&&(i.isDirty=ko.observable(!1),i.originalValue=i(),i.setOriginalValue=function(e){i.originalValue=e},i.subscribe(function(t){var a=t!=i.originalValue;a&&(o(),e()),i.isDirty(a)})),i},ko.options.deferUpdates=!0,WORKSPACE.Init()});