var WORKSPACE={VIEW:0,DEBUG:!1,PeerOptions:{key:"rv687hwetjz41jor",config:{iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"turn:numb.viagenie.ca:3478?transport=udp",credential:"muazkh",username:"webrtc@live.com"},{url:"turn:numb.viagenie.ca:3478?transport=tcp",credential:"muazkh",username:"webrtc@live.com"}]},debug:2,secure:"https:"==window.location.protocol},EraseClicked:!1,PanelList:[],Alerted:!1,ColumnCount:3,LargeColumnWidth:0,ViewModels:{},GridLayers:[],GridImageOverlay:null,CurrentGridImage:null,Windows:[],LastGridHash:null,MinVal:0,MaxVal:0,IsLoaded:!1,ShowDistance:!1,CurrentGame:null,DownX:0,DownY:0,ErasePoints:{},GridState:1,GameList:[],MapSlides:[],DefaultPlayerToken:"https://i.imgur.com/VcUMoh7.png",DefaultNPCToken:"https://i.imgur.com/4pfG5lQ.png",TokenSize:{T:12,S:50,M:50,L:100,H:150,G:250,C:400},CRArray:["","0","1/8","1/4","1/2",1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],XPPerLevel:{1:[25,50,75,100],2:[50,100,150,200],3:[75,150,225,400],4:[125,250,375,500],5:[250,500,750,1100],6:[300,600,900,1400],7:[350,750,1100,1700],8:[450,900,1400,2100],9:[550,1100,1600,2400],10:[600,1200,1900,2800],11:[800,1600,2400,3600],12:[1e3,2e3,3e3,4500],13:[1100,2200,3400,5100],14:[1250,2500,3800,5700],15:[1400,2800,4300,6400],16:[1600,3200,4800,7200],17:[2e3,3900,5900,8800],18:[2100,4200,6300,9500],19:[2400,4900,7300,10900],20:[2800,5700,8500,12700]},XPPerCR:{0:10,"1/8":25,"1/4":50,"1/2":100,1:200,2:450,3:700,4:1100,5:1800,6:2300,7:2900,8:3900,9:5e3,10:5900,11:7200,12:8400,13:1e4,14:11500,15:13e3,16:15e3,17:18e3,18:2e4,19:22e3,20:25e3,21:33e3,22:41e3,23:5e4,24:62e3,25:75e3,26:9e4,27:105e3,28:12e4,29:135e3,30:155e3},Multipliers:[1,1.5,2,2.5,3,4,5],DefaultPanels:["Combat","Players","Spells","Loot","NPCs","Game","Roll"],DistanceFrom:{top:0,left:0},DialogSize:{PlayersViewModel:{Width:"20vw",Height:"auto"},CombatViewModel:{Width:"32vw",Height:"auto"},LootViewModel:{Width:"auto",Height:"auto"},RollViewModel:{Width:"215px",Height:"auto"},GameViewModel:{Width:"15vw",Height:"auto"},Default:{Width:"22vw",Height:"auto"}},Init:function(){WORKSPACE.DEBUG&&console.log("Init"),WORKSPACE.SaveViewModel=new SaveViewModel,WORKSPACE.Load(),WORKSPACE.InitDraw()},SupportsStorage:function(){var e,o=new Date;try{return localStorage.setItem(o,o),e=localStorage.getItem(o)==o,localStorage.removeItem(o),e&&localStorage}catch(e){if(!WORKSPACE.Alerted){var i="Your browser does not support Local File Web Storage.\nSession data will not be saved.";alert(i),WORKSPACE.Alerted=!0}return!1}},InitDraw:function(){WORKSPACE.DEBUG&&console.log("Add Elements"),$.each(WORKSPACE.PanelList,function(e,o){$.each(o,function(e,o){var i=o,t=i.title+"ViewModel",a="."+t.toLowerCase()+"-inc";"function"==typeof window[t]&&(ko.applyBindings(WORKSPACE.ViewModels[t],$(a)[0]),WORKSPACE.ViewModels[t].Selector=a);var l=WORKSPACE.ViewModels[t],n=$(a).dialog({autoOpen:!0,title:i.title,width:WORKSPACE.DialogSize[t]?WORKSPACE.DialogSize[t].Width:WORKSPACE.DialogSize.Default.Width,resizable:"CombatViewModel"==t,modal:!1}).dialogExtend({closable:!1,minimizable:!0,collapsable:!1,dblclick:"maximize"}).on("dialogdragstop",function(e,o){"object"==typeof l&&WORKSPACE.ViewModels[t].Position({Left:o.position.left,Top:o.position.top})}).bind("dialogextendminimize",function(e){"object"==typeof l&&WORKSPACE.ViewModels[t].IsMinimized(!0)}).bind("dialogextendrestore",function(e){"object"==typeof l&&WORKSPACE.ViewModels[t].IsMinimized(!1)});WORKSPACE.Windows.push({ViewModel:l,Element:n}),"object"==typeof l&&($(a).parent().css("left",l.Position().Left),$(a).parent().css("top",l.Position().Top),l.IsMinimized()&&n.dialogExtend("minimize"))})}),$(".lootviewmodel-inc").tabs({active:WORKSPACE.ViewModels.LootViewModel.ActiveTab()}),$(".spellsviewmodel-inc").tabs({active:WORKSPACE.ViewModels.SpellsViewModel.ActiveTab()}),$(".npcsviewmodel-inc").tabs({active:WORKSPACE.ViewModels.NPCsViewModel.ActiveTab()}),$(".combatviewmodel-inc").tabs({active:WORKSPACE.ViewModels.CombatViewModel.ActiveTab()}),$(".loot-rarity").chosen({width:"100%"}),WORKSPACE.SpellView=$("#SpellView").dialog({autoOpen:!1,width:"40vw",resizable:!0,height:"auto",modal:!0,dialogClass:"view-title",buttons:{"Add to Spellbook":function(){$(this).dialog("close"),WORKSPACE.Spellbooks.dialog("open")},Close:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.ItemView=$("#ItemView").dialog({autoOpen:!1,resizable:!0,modal:!0,width:"auto",dialogClass:"view-title",buttons:{Close:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.NPCView=$("#NPCView").dialog({autoOpen:!1,resizable:!0,modal:!0,dialogClass:"view-title",width:"760px",buttons:{"Add to Group":function(){WORKSPACE.NPCGroups.dialog("open")},"Send to Combat":function(){var e=new NPCModel,o=WORKSPACE.ViewModels.NPCsViewModel.CurrentNPCId;e.Load(o,MONSTERS[o]),WORKSPACE.ViewModels.CombatViewModel.AddCombatant(ko.toJS(e))},Close:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.NPCGroups=$("#NPCGroups").dialog({autoOpen:!1,modal:!0,buttons:{Confirm:function(){var e=WORKSPACE.ViewModels.NPCsViewModel;e.SelectedGroup().AddNPC(e.CurrentNPCId),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.Spellbooks=$("#Spellbooks").dialog({autoOpen:!1,modal:!0,buttons:{Confirm:function(){var e=WORKSPACE.ViewModels.SpellsViewModel;e.SelectedBook().AddSpell(e.CurrentSpellId),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.RenameBook=$("#RenameBook").dialog({autoOpen:!1,modal:!0,buttons:{Done:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.RenameGroup=$("#RenameGroup").dialog({autoOpen:!1,modal:!0,buttons:{Done:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.RenameGame=$("#RenameGame").dialog({autoOpen:!1,modal:!0,buttons:{Done:function(){$(this).dialog("close")}},position:{my:"center",at:"center",of:window}}),WORKSPACE.ResizeGridOrig="",WORKSPACE.ResizeGrid=function(e){var o=$(".combatviewmodel-inc"),i=$(".combatviewmodel-inc > .ui-tabs-nav"),t=o.height()-i.height()-12,a=o.width();$("#grid-map").css("height",t+"px"),$("#grid-canvas").attr("height",t+1),$("#grid-canvas").attr("width",a+6),WORKSPACE.GridMap&&e&&WORKSPACE.GridMap.invalidateSize()},WORKSPACE.ResizeGrid();var e=$(".combatviewmodel-inc");e.on("dialogresize",function(e,o){WORKSPACE.ResizeGrid(!0)}),e.on("dialogextendbeforeMaximize",function(e){var o=$("#GridTab"),i=o.parent();WORKSPACE.ResizeGridOrig=i.height()+i.offset().top-o.offset().top+"px"}),e.on("dialogextendmaximize",function(e){WORKSPACE.ResizeGrid(!0)}),e.on("dialogextendrestore",function(e){$("#grid-map").css("height",WORKSPACE.ResizeGridOrig),WORKSPACE.ResizeGrid(!0)}),WORKSPACE.SpellViewVM=new SpellModel,WORKSPACE.ItemViewVM=new ItemModel,WORKSPACE.NPCViewVM=new NPCModel,ko.applyBindings(WORKSPACE.SpellViewVM,$("#SpellView")[0]),ko.applyBindings(WORKSPACE.ItemViewVM,$("#ItemView")[0]),ko.applyBindings(WORKSPACE.NPCViewVM,$("#NPCView")[0]),ko.applyBindings(WORKSPACE.ViewModels.SpellsViewModel,$("#Spellbooks")[0]),ko.applyBindings(WORKSPACE.ViewModels.SpellsViewModel,$("#RenameBook")[0]),ko.applyBindings(WORKSPACE.ViewModels.NPCsViewModel,$("#NPCGroups")[0]),ko.applyBindings(WORKSPACE.ViewModels.NPCsViewModel,$("#RenameGroup")[0]),ko.applyBindings(WORKSPACE.ViewModels.GameViewModel,$("#RenameGame")[0]),L.Map=L.Map.extend({openPopup:function(e,o,i){if(!(e instanceof L.Popup)){var t=e;e=new L.Popup(i).setContent(t)}return o&&e.setLatLng(o),this.hasLayer(e)?this:(this._popup=e,this.addLayer(e))},closePopup:function(e){return e&&e!==this._popup||(e=this._popup,this._popup=null),e&&(this.removeLayer(e),e._isOpen=!1),this},bindPopup:function(e,o){var i=L.point(this.options.icon.options.popupAnchor||[0,0]);return i=i.add(L.Popup.prototype.options.offset),o&&o.offset&&(i=i.add(o.offset)),o=L.extend({offset:i},o),this._popupHandlersAdded||(this.on("click",this.togglePopup,this).on("remove",this.closePopup,this).on("move",this._movePopup,this),this._popupHandlersAdded=!0),e instanceof L.Popup?(L.setOptions(e,o),this._popup=e,e._source=this):this._popup=new L.Popup(o,this).setContent(e),this}}),WORKSPACE.GridMap=new L.map("grid-map",{crs:L.CRS.Simple,minZoom:1,maxZoom:7,attributionControl:!1}),WORKSPACE.AddErasePoint=function(e,o){var i=$("#grid-fog"),t=WORKSPACE.GridMap.getZoom();WORKSPACE.ErasePoints[t]=WORKSPACE.ErasePoints[t]||{points:[]},WORKSPACE.ErasePoints[t].points.push({x:e.pageX-i.offset().left,y:e.pageY-i.offset().top,dragging:!o,size:WORKSPACE.ViewModels.CombatViewModel.EraseSize()}),WORKSPACE.Helpers.DrawFog(),WORKSPACE.Helpers.SaveCombatVM()},WORKSPACE.GridMap.on("contextmenu",function(e){}),WORKSPACE.GridMap.on("mousedown",function(e){var o=e.originalEvent,i=WORKSPACE.DistanceFrom;o.stopPropagation(),2==o.button&&(WORKSPACE.GridState?(i.left=o.pageX,i.top=o.pageY,WORKSPACE.ShowDistance=!0):!WORKSPACE.GridState&&WORKSPACE.ViewModels.CombatViewModel.ShowFog()&&(WORKSPACE.DownX=o.pageX,WORKSPACE.DownY=o.pageY,WORKSPACE.EraseClicked=!0,WORKSPACE.AddErasePoint(o,!0)))}),WORKSPACE.GridMap.on("mousemove",function(e){var o=e.originalEvent;if(WORKSPACE.Helpers.DrawDistance(o),!WORKSPACE.GridState&&WORKSPACE.EraseClicked&&WORKSPACE.ViewModels.CombatViewModel.ShowFog()){var i=o.pageX-WORKSPACE.DownX,t=o.pageY-WORKSPACE.DownY;Math.sqrt(i*i+t*t)>=WORKSPACE.ViewModels.CombatViewModel.EraseSize()/2&&(WORKSPACE.AddErasePoint(o),WORKSPACE.DownX=o.pageX,WORKSPACE.DownY=o.pageY)}WORKSPACE.GridMap.invalidateSize()}),$(document).on("mouseup",function(e){WORKSPACE.Helpers.DisableDistance(e),!WORKSPACE.GridState&&WORKSPACE.EraseClicked&&WORKSPACE.ViewModels.CombatViewModel.ShowFog()&&WORKSPACE.AddErasePoint(e),WORKSPACE.EraseClicked=!1}),WORKSPACE.DrawFog=function(){if(WORKSPACE.ViewModels.CombatViewModel.ShowFog()){var e=$("#grid-fog")[0],o=e.getContext("2d");o.clearRect(0,0,e.width,e.height),o.globalCompositeOperation="source-over",o.fillStyle=WORKSPACE.ViewModels.CombatViewModel.FogColor().replace(")",", 0.65)").replace("rgb","rgba"),o.fillRect(0,0,e.width,e.height)}},WORKSPACE.AdjustFog=function(){var e=$("#grid-fog"),o=(e[0].getContext("2d"),$(".leaflet-image-layer"));e.css("transform",o[0].style.transform),e.attr("width",o.width()),e.attr("height",o.height()),WORKSPACE.Helpers.DrawFog()},WORKSPACE.GridMap.on("move",function(e){var o=$("#grid-lines"),i=$(".leaflet-image-layer"),t=$("#grid-fog");t[0].getContext("2d");o&&i&&(o.css("transform",i[0].style.transform),o.css("width",i.width()),o.css("height",i.height()),t.css("transform",i[0].style.transform),t.attr("width",i.width()),t.attr("height",i.height()),WORKSPACE.Helpers.DrawFog())}),WORKSPACE.GridMap.on("zoomstart",function(e){WORKSPACE.DrawFog()}),WORKSPACE.GridMap.on("zoomend",function(e){WORKSPACE.ViewModels.CombatViewModel.GridZoom(WORKSPACE.GridMap.getZoom()),WORKSPACE.AdjustFog(),WORKSPACE.SetPlayerZoom.zoom==WORKSPACE.GridMap.getZoom()?WORKSPACE.SetPlayerZoom.disable():WORKSPACE.SetPlayerZoom.enable()}),WORKSPACE.GridMap.on("moveend",function(e){WORKSPACE.ViewModels.CombatViewModel.GridCenter(WORKSPACE.GridMap.getCenter())}),$("#grid-lines").appendTo($(".leaflet-map-pane")),$("#grid-fog").appendTo($(".leaflet-map-pane")),WORKSPACE.ViewModels.CombatViewModel.LoadTokens(),$("#token-scale").slider({range:"min",value:1,min:.5,step:.1,max:3,slide:function(e,o){WORKSPACE.ViewModels.CombatViewModel.TokenScale(o.value)}}),$("#erase-size").slider({range:"min",value:100,min:10,step:10,max:200,slide:function(e,o){WORKSPACE.ViewModels.CombatViewModel.EraseSize(o.value)}}),$("#grid-bgcolor").spectrum({color:WORKSPACE.ViewModels.CombatViewModel.BackgroundColor(),showAlpha:!0,change:function(e){WORKSPACE.ViewModels.CombatViewModel.BackgroundColor(e.toRgbString())}}),$("#grid-linecolor").spectrum({color:WORKSPACE.ViewModels.CombatViewModel.GridColor(),showAlpha:!0,change:function(e){WORKSPACE.ViewModels.CombatViewModel.GridColor(e.toRgbString())}}),$("#grid-fogcolor").spectrum({color:WORKSPACE.ViewModels.CombatViewModel.FogColor(),change:function(e){WORKSPACE.ViewModels.CombatViewModel.FogColor(e.toRgbString())}}),$("#grid-darknesscolor").spectrum({color:WORKSPACE.ViewModels.CombatViewModel.DarknessColor(),change:function(e){WORKSPACE.ViewModels.CombatViewModel.DarknessColor(e.toRgbString())}});var o=L.easyButton({states:[{stateName:"grid-erase",icon:"fa fa-eraser",title:"Fog Eraser",onClick:function(e){WORKSPACE.GridState=!WORKSPACE.GridState,WORKSPACE.GridState?this.enable():this.disable()}}]});o.addTo(WORKSPACE.GridMap),L.DomUtil.addClass(o.button,"eraser-toggle");var i=L.easyButton({states:[{stateName:"player-panto",icon:"fa fa-arrows",title:"Pan Players' Screen",onClick:function(e){WORKSPACE.ViewModels.CombatViewModel.PanTo(WORKSPACE.GridMap.getCenter())}}]});i.addTo(WORKSPACE.GridMap),WORKSPACE.SetPlayerZoom=L.easyButton({states:[{stateName:"player-zoom",icon:"fa fa-crosshairs",title:"Set Player Zoom",onClick:function(e){WORKSPACE.ViewModels.CombatViewModel.SetPlayerZoom(),this.zoom=WORKSPACE.GridMap.getZoom(),this.disable()}}]}),WORKSPACE.SetPlayerZoom.addTo(WORKSPACE.GridMap),WORKSPACE.SetPlayerZoom.zoom=WORKSPACE.GridMap.getZoom(),WORKSPACE.DrawFog(),WORKSPACE.HideOverlay(),WORKSPACE.IsLoaded=!0,WORKSPACE.Debug&&console.log("> Workspace Loaded"),WORKSPACE.ViewModels.GameViewModel.Save()},HideOverlay:function(){$("#overlay").fadeOut()},LoadDefaultData:function(){WORKSPACE.DEBUG&&console.log("> Default Data"),WORKSPACE.CurrentGame=new GameModel("Game1"),WORKSPACE.GameList=[ko.toJS(WORKSPACE.CurrentGame)],WORKSPACE.PanelList=[];var e=0;for(i=0;i<WORKSPACE.DefaultPanels.length;i++)void 0===WORKSPACE.PanelList[e]&&(WORKSPACE.PanelList[e]=[]),WORKSPACE.PanelList[e].push(new Panel(WORKSPACE.DefaultPanels[i])),e++,e>WORKSPACE.ColumnCount-1&&(e=0);WORKSPACE.ViewModels.GameViewModel.LoadGameList(WORKSPACE.GameList),WORKSPACE.ViewModels.GameViewModel.LoadSelectedGame(WORKSPACE.CurrentGame)},LoadPanelOrder:function(e){for(WORKSPACE.DEBUG&&console.log("> Panel Order"),c=0;c<e.length;c++)for(WORKSPACE.PanelList.push([]),i=0;i<e[c].length;i++)WORKSPACE.PanelList[c].push(new Panel(e[c][i]))},LoadViewModels:function(e){WORKSPACE.DEBUG&&console.log("> View Models...");var o=new GameModel(e.Name);WORKSPACE.CurrentGame=o;var t=JSON.parse(localStorage.getItem(o.Id()));if(null===t){WORKSPACE.PanelList=[];var a=0;for(i=0;i<WORKSPACE.DefaultPanels.length;i++)void 0===WORKSPACE.PanelList[a]&&(WORKSPACE.PanelList[a]=[]),WORKSPACE.PanelList[a].push(new Panel(WORKSPACE.DefaultPanels[i])),a++,a>WORKSPACE.ColumnCount-1&&(a=0);WORKSPACE.ViewModels.GameViewModel.LoadGameList(WORKSPACE.GameList),WORKSPACE.ViewModels.GameViewModel.LoadSelectedGame(o)}else $.each(t.ViewModels,function(e,o){WORKSPACE.DEBUG&&console.log("> > "+o.Key);try{var i=JSON.parse(o.ViewModel);i&&WORKSPACE.ViewModels[o.Key].Load(i)}catch(e){WORKSPACE.ViewModels[o.Key].Load(o.ViewModel)}})},Load:function(){if(WORKSPACE.DEBUG&&console.log("Loading..."),WORKSPACE.SupportsStorage()){var e=JSON.parse(localStorage.getItem("WORKSPACE"));e?(WORKSPACE.LoadDefaultData(),void 0!==e.GameList&&void 0!==e.CurrentGame&&""!==e.CurrentGame.Id&&""!==e.CurrentGame.Name&&(WORKSPACE.GameList=e.GameList,WORKSPACE.MapSlides=e.MapSlides||[],WORKSPACE.LoadViewModels(e.CurrentGame),WORKSPACE.ViewModels.CombatViewModel.MapSlides(WORKSPACE.MapSlides.concat(WORKSPACE.ViewModels.CombatViewModel.MapSlides())))):WORKSPACE.LoadDefaultData()}else WORKSPACE.LoadDefaultData()},Save:function(){if(WORKSPACE.IsLoaded&&WORKSPACE.SupportsStorage()){WORKSPACE.DEBUG&&console.log("Saving");var e=[];$.each(WORKSPACE.ViewModels,function(o,i){e.push({Key:o,ViewModel:ko.toJSON(i)})}),localStorage.setItem(WORKSPACE.CurrentGame.Id(),JSON.stringify({ViewModels:e})),WORKSPACE.CacheSave=e}},Clear:function(){WORKSPACE.SupportsStorage()&&localStorage.clear()}};WORKSPACE.Helpers={DrawFog:function(){if(WORKSPACE.ViewModels.CombatViewModel&&WORKSPACE.ViewModels.CombatViewModel.ShowFog()){var e=$("#grid-fog")[0],o=e.getContext("2d");o.clearRect(0,0,e.width,e.height),o.globalCompositeOperation="source-over",o.fillStyle=WORKSPACE.ViewModels.CombatViewModel.FogColor().replace(")",", 0.65)").replace("rgb","rgba"),o.fillRect(0,0,e.width,e.height);var t=WORKSPACE.GridMap.getZoom(),a=WORKSPACE.ErasePoints[t];for(i=0;a&&i<a.points.length;i++){var l=a.points[i].x,n=a.points[i].y;o.beginPath(),i>0&&a.points[i].dragging?o.moveTo(a.points[i-1].x,a.points[i-1].y):o.moveTo(l-1,n),o.lineTo(l,n),o.closePath(),o.globalCompositeOperation="destination-out",o.fillStyle="rgba(0,0,0,0);",o.strokeStyle="rgba(0,0,0,0);",o.lineJoin="round",o.lineWidth=a.points[i].size,o.stroke()}}},SaveCombatVM:function(){var e=WORKSPACE.ViewModels.CombatViewModel.TransmitMap(),o=WORKSPACE.ViewModels.CombatViewModel.TransmitMapRemote();if(e||o){var i=WORKSPACE.ViewModels.CombatViewModel.CompressModel(),t=i.hashCode();WORKSPACE.LastGridHash!=t&&(e&&(localStorage.setItem("MAPVIEW-Hash",t),localStorage.setItem("MAPVIEW-ViewModel",i)),o&&WORKSPACE.ViewModels.CombatViewModel.SendRemoteData(i),WORKSPACE.LastGridHash=t)}},DisableDistance:function(e){if(2==e.button){var o=$("#grid-canvas")[0],i=o.getContext("2d");WORKSPACE.ShowDistance=!1,i.clearRect(0,0,o.width,o.height)}},DrawDistance:function(e){if(WORKSPACE.ShowDistance){var o=$("#grid-canvas"),i={left:WORKSPACE.DistanceFrom.left-o.offset().left,top:WORKSPACE.DistanceFrom.top-o.offset().top},t={left:e.pageX-o.offset().left,top:e.pageY-o.offset().top},a=o[0].getContext("2d"),l=i.left,n=i.top,r=t.left,s=t.top,d=0;a.clearRect(0,0,o[0].width,o[0].height),d=WORKSPACE.Helpers.DrawLabel(a,{x:l,y:n},{x:r,y:s},"center","5"),d>2&&(a.setLineDash([5,5]),a.beginPath(),a.moveTo(l,n),a.lineTo(r,s),a.strokeStyle="red",a.stroke())}},DrawLabel:function(e,o,i,t,a){t||(t="center"),a||(a=0);var l,n,r,s,d=i.x-o.x,C=i.y-o.y,S=Math.sqrt(d*d+C*C),P=0,p=Math.atan2(C,d);if((p<-Math.PI/2||p>Math.PI/2)&&(l=o,o=i,i=l,d*=-1,C*=-1,p-=Math.PI),"center"==t)l=o,n=.5;else{var c="left"==t;l=c?o:i,n=a/Math.sqrt(d*d+C*C)*(c?1:-1)}return e.font="14px Arial",r=50*WORKSPACE.ViewModels.CombatViewModel.TokenScale(),P=(S/r*5).toFixed(1),s=P+" ft",P>2&&(e.save(),e.textAlign=t,e.translate(l.x+d*n,l.y+C*n),e.rotate(Math.atan2(C,d)),e.fillStyle="red",e.fillText(s,0,-5),e.restore()),P},SwapMap:function(e,o){if(WORKSPACE.CurrentGridImage!=e||o){WORKSPACE.CurrentGridImage=e;var i=new Image;if(o){var t=[[0,0],[o.height,o.width]];WORKSPACE.GridImageOverlay&&WORKSPACE.GridMap.removeLayer(WORKSPACE.GridImageOverlay),WORKSPACE.GridImageOverlay=new L.imageOverlay(null,t),WORKSPACE.GridImageOverlay.addTo(WORKSPACE.GridMap),WORKSPACE.GridMap.fitBounds(t)}else i.onload=function(){var e=i.height,o=i.width,t=o/e,a=[[0,0],[100,100*t]];WORKSPACE.GridImageOverlay&&WORKSPACE.GridMap.removeLayer(WORKSPACE.GridImageOverlay),WORKSPACE.GridImageOverlay=new L.imageOverlay(i.src,a),WORKSPACE.GridImageOverlay.addTo(WORKSPACE.GridMap),WORKSPACE.GridMap.fitBounds(a)},i.src=e}WORKSPACE.GridMap.invalidateSize()},TextFix:function(e){$(e).css({height:"auto","overflow-y":"hidden"}).height(e.scrollHeight)},Roll:function(e,o){return Math.floor(Math.random()*(o-e+1))+e},AddNPC:function(e,o){WORKSPACE.ViewModels.NPCsViewModel.CurrentNPCId=e.Id,WORKSPACE.NPCGroups.dialog("open")},AddSpell:function(e,o){WORKSPACE.ViewModels.SpellsViewModel.CurrentSpellId=e.Id,WORKSPACE.Spellbooks.dialog("open")},ViewSpell:function(e,o){WORKSPACE.SpellViewVM.Load(e,SPELLS[e]),WORKSPACE.ViewModels.SpellsViewModel.CurrentSpellId=e,WORKSPACE.SpellView.dialog("option","title",SPELLS[e].Name),WORKSPACE.SpellView.dialog("open")},ViewItem:function(e,o){WORKSPACE.ItemViewVM.Load(e,MAGIC[e]),WORKSPACE.ViewModels.LootViewModel.CurrentItemId=e,WORKSPACE.ItemView.dialog("option","title",MAGIC[e].name),WORKSPACE.ItemView.dialog("open")},ViewNPC:function(e,o){WORKSPACE.NPCViewVM.Load(e,MONSTERS[e]),WORKSPACE.ViewModels.NPCsViewModel.CurrentNPCId=e,WORKSPACE.NPCView.dialog("option","title",MONSTERS[e].name),WORKSPACE.NPCView.dialog("open"),WORKSPACE.NPCViewVM.PopulateSimilar()},RenameBook:function(e){WORKSPACE.RenameBook.dialog("open")},RenameGroup:function(e){WORKSPACE.RenameGroup.dialog("open")},RenameGame:function(e){WORKSPACE.RenameGame.dialog("open")},Throttle:function(e,o){var i=!1;return function(t){i||(e.apply(null,arguments),i=!0,setTimeout(function(){i=!1},o))}}};var Panel=function(e,o,i,t){this.title=e,this.contents=o,this.position=i;var a=t,l="";$.each(a,function(e,o){l+=e+":"+o+";"}),this.style=l;var n=this.title+"ViewModel";"function"==typeof window[n]&&(WORKSPACE.ViewModels[n]=new window[n])};$(function(){var e=WORKSPACE.Helpers.Throttle(WORKSPACE.Save,400),o=WORKSPACE.Helpers.Throttle(WORKSPACE.Helpers.SaveCombatVM,100);String.prototype.hashCode=function(){var e=0;if(0===this.length)return e;for(i=0;i<this.length;i++)char=this.charCodeAt(i),e=(e<<5)-e+char,e&=e;return e},String.prototype.levenstein=function(e){var o,i,t=this,a=e+"",l=[],n=Math.min;if(!t||!a)return(a||t).length;for(o=0;o<=a.length;l[o]=[o++]);for(i=0;i<=t.length;l[0][i]=i++);for(o=1;o<=a.length;o++)for(i=1;i<=t.length;i++)l[o][i]=a.charAt(o-1)==t.charAt(i-1)?l[o-1][i-1]:l[o][i]=n(l[o-1][i-1]+1,n(l[o][i-1]+1,l[o-1][i]+1));return l[a.length][t.length]},ko.extenders.defaultIfNull=function(e,o){var i=ko.computed({read:e,write:function(i){e(i?i:o)}});return i(e()),i},ko.extenders.trackChange=function(i,t){return t&&(i.originalValue=i(),i.setOriginalValue=function(e){i.originalValue=e},i.subscribe(function(t){t!=i.originalValue&&(o(),e(),i.setOriginalValue(t))})),i},ko.bindingHandlers.slider={init:function(e,o,i){var t=i().sliderOptions||{},a=t.type;$(e).slider(t),ko.utils.registerEventHandler(e,"slidechange",function(e,i){var t=o();"loot-chance"==a?t.Chance(i.value):"loot-range"==a?(t.Min(i.values[0]),t.Max(i.values[1])):t(i.values?i.values:i.value)}),ko.utils.domNodeDisposal.addDisposeCallback(e,function(){$(e).slider("destroy")}),ko.utils.registerEventHandler(e,"slide",function(e,i){var t=o();"loot-chance"==a?t.Chance(i.value):"loot-range"==a?(t.Min(i.values[0]),t.Max(i.values[1])):t(i.values?i.values:i.value)})},update:function(e,o){var i=ko.utils.unwrapObservable(o()),t=$(e);t.hasClass("loot-chance")?t.slider("value",i.Chance()):t.hasClass("loot-range")?t.slider("values",[i.Min(),i.Max()]):(isNaN(i)&&(i=0),t.slider("value",i))}},ko.options.deferUpdates=!0,WORKSPACE.Init()});