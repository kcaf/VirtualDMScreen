var CombatantModel=function(){var e=this;e.Id=ko.observable(null).extend({trackChange:!0}),e.ModelType=ko.observable().extend({trackChange:!0}),e.Size=ko.observable().extend({trackChange:!0}),e.Name=ko.observable("").extend({trackChange:!0}),e.Initiative=ko.observable().extend({trackChange:!0}),e.AC=ko.observable().extend({trackChange:!0}),e.HP=ko.observable().extend({trackChange:!0}),e.Skip=ko.observable().extend({trackChange:!0}),e.Effects=ko.observableArray().extend({trackChange:!0}),e.Level=ko.observable().extend({trackChange:!0}),e.CR=ko.observable().extend({trackChange:!0}),e.MaxHP=ko.observable().extend({trackChange:!0}),e.LatLng=ko.observable().extend({trackChange:!0}),e.Token=ko.observable(null).extend({trackChange:!0}),e.Angle=ko.observable(0).extend({trackChange:!0}),e.Invisible=ko.observable(!1).extend({trackChange:!0}),e.IsSelected=ko.observable(!1).extend({trackChange:!0}),e.Name.subscribe(function(o){$.each(WORKSPACE.ViewModels.CombatViewModel.CustomIcons(),function(o,t){t.name==e.Name()&&(e.Token(t.token),WORKSPACE.ViewModels.CombatViewModel.LoadTokens())})}),e.Invisible.subscribe(function(e){WORKSPACE.ViewModels.CombatViewModel.LoadTokens()}),e.PickToken=function(o,t){var n=prompt("Token URL",""),a=WORKSPACE.ViewModels.CombatViewModel;n&&(e.Token(n),$.each(a.CustomIcons(),function(o,t){t&&t.name==e.Name()&&a.RemoveIcon(t)}),a.AddIcon({name:e.Name(),token:n}),a.LoadTokens())},e.ViewCombatant=function(o,t){null!==e.Id()&&"NPC"==e.ModelType()&&WORKSPACE.Helpers.ViewNPC(e.Id(),t)},e.TokenClasses=function(o){return(e.ModelType()?e.ModelType().toLowerCase()+" ":"unknown ")+(o?"outline "+e.ModelType()+" ":"")+(e.Invisible()?"invisible ":"")+(e.IsDead()?"dead ":"")+(e.IsSelected()?"blink ":"")},e.IsDead=ko.pureComputed(function(){return e.HP()<=0}),e.RowClass=ko.pureComputed(function(){return(e.ModelType()?e.ModelType().toLowerCase():"unknown")+"-row "+(e.IsDead()?"dead ":"")+("size-"+e.Size())+" "+(e.IsSelected()?"selected ":"")}),e.NameShort=ko.pureComputed(function(){return e.Name()&&e.Name().length?e.Name().slice(0,1):e.Name()}),e.XP=ko.pureComputed(function(){var o=parseInt(e.CR());return o>=0?WORKSPACE.XPPerCR[e.CR()]:0}),e.ACBasic=ko.pureComputed({read:function(){return e.AC()?e.AC().split(" ")[0]:""},write:function(o){e.AC(o)},owner:e}),e.MaxHPText=ko.pureComputed(function(){return e.MaxHP()?"Max: "+e.MaxHP():e.HP()}),e.LevelAndCR=ko.pureComputed({read:function(){var o;return o="Player"==e.ModelType()?e.Level():"NPC"==e.ModelType()?e.CR():e.CR()},write:function(o){"Player"==e.ModelType()?e.Level(o):"NPC"==e.ModelType()?e.CR(o):e.CR(o)}}),e.HP.subscribe(function(e){WORKSPACE.ViewModels.CombatViewModel.LoadTokens()}),e.CalculateHP=ko.pureComputed({read:function(){return e.HP()},write:function(o){for(var t=0,n=o.match(/[+\-]*(\.\d+|\d+(\.\d+)?)/g)||[];n.length;)t+=parseFloat(n.shift());e.MaxHP()||e.MaxHP(e.HP()),e.HP(""===o?o:t)},owner:e}),e.Load=function(o){if("Player"==o.ModelType)WORKSPACE.VIEW||e.Initiative(o.Initiative),e.HP(o.HP),e.Level(o.Level),e.Size("M"),e.Invisible(o.Invisible);else if("NPC"==o.ModelType){if(e.Id(o.Id),e.Size(o.Size),e.Invisible(o.Invisible!==!1),e.CR(o.CR),!WORKSPACE.VIEW){var t=o.Initiative||WORKSPACE.Helpers.Roll(1,20)+parseInt(o.DEXMOD);e.Initiative(t>=0?t:0)}if(WORKSPACE.VIEW)e.HP(o.HP);else{var n=(""+o.HP).split("("),a=[],r=0;if("object"==typeof n&&n.length>1){for(n=n[1].split(")"),a=n[0].match(/\d+d\d+/g),rollSplit=a[0].split("d"),i=0;i<rollSplit[0];i++)r+=parseInt(WORKSPACE.Helpers.Roll(1,rollSplit[1]));r+=parseInt(n[0].slice(a[0].length))||0}else r=parseInt(n[0]);var l=(""+o.HP).split("d");"object"==typeof l&&l.length>1?e.HP(r):e.HP(o.HP||r)}}else e.Size("M"),e.CR(o.CR),e.Invisible(o.Invisible!==!1),e.HP(o.HP);e.MaxHP(o.MaxHP||null),e.ModelType(o.ModelType),e.Name(o.Name||""),e.AC(o.AC),e.Skip(o.Skip||!1),e.Effects(o.Effects||[]),e.LatLng(o.LatLng||null),e.Token(o.Token||null),e.Angle(o.Angle||0),e.IsSelected(o.IsSelected||!1)},e.AddEffect=function(){}};CombatantModel.prototype.toJSON=function(){var e=ko.toJS(this);return delete e.CalculateHP,delete e.LevelAndCR,delete e.MaxHPText,delete e.ACBasic,delete e.XP,delete e.NameShort,delete e.RowClass,e};var CombatViewModel=function(){var e=this;e.Selector=null,e.Interval=null,e.ActiveTab=ko.observable(0).extend({trackChange:!0}),e.CombatantList=ko.observableArray().extend({trackChange:!0}),e.Combatant=new CombatantModel,e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.GridWidth=ko.observable(),e.MapSlides=ko.observableArray().extend({trackChange:!0}),e.MapToAdd=ko.observable(),e.ShowGridLines=ko.observable(!0).extend({trackChange:!0}),e.AltGridColor=ko.observable(!1).extend({trackChange:!0}),e.ActiveMap=ko.observable("").extend({trackChange:!0}),e.ShowOutlines=ko.observable(!1).extend({trackChange:!0}),e.CustomIcons=ko.observableArray().extend({trackChange:!0}),e.TokenScale=ko.observable(1).extend({trackChange:!0}),e.TransmitMap=ko.observable(!1).extend({trackChange:!0}),e.TransmitMapRemote=ko.observable(!1),e.Peer=null,e.PeerKey=ko.observable(),e.PeerConnections=ko.observableArray(),e.ConnectedClients=ko.observable(0),e.ConnTimeout=null,e.LastTimestamp=0,e.GridCenter=ko.observable([0,0]).extend({trackChange:!0}),e.GridZoom=ko.observable(1).extend({trackChange:!0}),e.PlayerZoom=ko.observable(1).extend({trackChange:!0}),e.ShowDarkness=ko.observable(!1).extend({trackChange:!0}),e.ShowFog=ko.observable(!1).extend({trackChange:!0}),e.BackgroundColor=ko.observable("#ddd").extend({trackChange:!0}),e.GridColor=ko.observable("#000").extend({trackChange:!0}),e.DarknessColor=ko.observable("rgba(0,0,0)").extend({trackChange:!0}),e.FogColor=ko.observable("rgb(0,0,0)").extend({trackChange:!0}),e.EraseSize=ko.observable(100).extend({trackChange:!0}),e.PageSize=ko.observable(12),e.PageIndex=ko.observable(0),e.CompressModel=function(){var o,t={ErasePoints:WORKSPACE.ErasePoints,FogColor:e.FogColor(),DarknessColor:e.DarknessColor(),GridColor:e.GridColor(),BackgroundColor:e.BackgroundColor(),ShowGridLines:e.ShowGridLines(),ActiveMap:e.ActiveMap(),ShowOutlines:e.ShowOutlines(),TokenScale:e.TokenScale(),GridCenter:e.GridCenter(),GridZoom:e.PlayerZoom(),ShowDarkness:e.ShowDarkness(),ShowFog:e.ShowFog(),CombatantList:[]};return $.each(e.CombatantList(),function(e,n){o={Id:n.Id(),ModelType:n.ModelType(),Size:n.Size(),Name:"Player"==n.ModelType()?n.Name():"",HP:n.IsDead()?0:1,LatLng:n.LatLng(),Token:n.Token(),Angle:n.Angle(),Invisible:n.Invisible()},t.CombatantList.push(o)}),JSON.stringify(t)},e.AddIcon=function(o){e.CustomIcons.push(o)},e.RemoveIcon=function(o){e.CustomIcons.remove(o)},e.ClearFog=function(){WORKSPACE.ErasePoints={},WORKSPACE.Helpers.DrawFog(),WORKSPACE.Helpers.SaveCombatVM()},e.SetPlayerZoom=function(){e.PlayerZoom(e.GridZoom())},e.SelectRow=function(o){return o.IsSelected()||($.each(e.CombatantList(),function(e,o){o.IsSelected(!1)}),o.IsSelected(!0),e.LoadTokens()),!0},e.CombatantList.subscribe(function(o){e.LoadTokens()}),e.ShowOutlines.subscribe(function(o){e.LoadTokens()}),e.TokenScale.subscribe(function(o){o&&e.LoadTokens()}),e.MapSlidesPage=ko.pureComputed(function(){var o=e.PageSize()*e.PageIndex();return e.MapSlides().slice(o,o+e.PageSize())}),e.PageMax=ko.pureComputed(function(){return Math.ceil(e.MapSlides().length/e.PageSize())-1}),e.isPageMin=ko.pureComputed(function(){return e.PageIndex()<=0}),e.isPageMax=ko.pureComputed(function(){return e.PageIndex()>=e.PageMax()}),e.MapPrev=function(){e.isPageMin()||e.PageIndex(e.PageIndex()-1)},e.MapNext=function(){e.isPageMax()||e.PageIndex(e.PageIndex()+1)},e.TransmitMapRemote.subscribe(function(o){o?(e.Peer=new Peer(null,WORKSPACE.PeerOptions),e.PeerKey("Loading..."),e.Peer.on("open",function(o){e.PeerKey(o),e.SendRemoteData(e.CompressModel()),e.Peer.on("connection",function(o){e.ConnectionReceived(o)})})):(e.Peer.destroy(),e.PeerConnections([]),clearInterval(e.ConnInterval))}),e.ConnectionReceived=function(o){o.on("open",function(){e.PeerConnections.push(o),e.SendRemoteData(e.CompressModel()),o.on("close",function(){e.ConnectionClosed(o)})}),o.on("error",function(e){console.log(e)})},e.ConnectionClosed=function(o){e.PeerConnections.remove(o)},e.SendRemoteData=function(o){clearTimeout(e.ConnTimeout);var t=0;$.each(e.PeerConnections(),function(e,n){n.open&&(t++,n.send(o))}),e.ConnectedClients(t),e.ConnTimeout=setTimeout(function(){e.SendRemoteData(e.CompressModel())},1e3)},e.LoadTokens=function(o){$.each(WORKSPACE.GridLayers,function(e,o){WORKSPACE.GridMap.removeLayer(o)});var t=WORKSPACE.TokenSize.M*e.TokenScale()+"px";t=t+" "+t,$("#grid-lines").css("background-size",t),$.each(e.CombatantList(),function(t,n){if(!n.Invisible()||!WORKSPACE.VIEW||n.IsDead()){var a=null;if(n.Name()&&""!==n.Name()&&$.each(e.CustomIcons(),function(e,o){o.name==n.Name()&&(a=o.token)}),null===a)if(null===n.Token())a="Player"==n.ModelType()?WORKSPACE.DefaultPlayerToken:WORKSPACE.DefaultNPCToken,n.Token(a);else{a=n.Token();var r=!1;$.each(e.CustomIcons(),function(o,t){t&&t.name==n.Name()&&(r=!0,e.CustomIcons.remove(t))}),e.CustomIcons.push({name:n.Name(),token:n.Token()})}var i=n.TokenClasses(e.ShowOutlines()),l=WORKSPACE.TokenSize[n.Size()]*e.TokenScale(),s=new L.icon({iconUrl:a,iconSize:[l,l],className:i});n.LatLng(!n.LatLng()||o?L.latLng(50,50):n.LatLng());var d=new L.marker(n.LatLng(),{draggable:!WORKSPACE.VIEW,icon:s,title:WORKSPACE.VIEW&&"Player"!=n.ModelType()?"":n.Name(),alt:WORKSPACE.VIEW&&"Player"!=n.ModelType()?"":n.Name(),iconAngle:n.Angle()});d.on("mousedown",function(e){var o=e.originalEvent,t=WORKSPACE.DistanceFrom;o.stopPropagation(),2==o.button&&(t.left=$(o.srcElement).offset().left+$(o.srcElement).width()/2,t.top=$(o.srcElement).offset().top+$(o.srcElement).height()/2,WORKSPACE.ShowDistance=!0)}),d.on("mouseup",function(e){WORKSPACE.Helpers.DisableDistance(e.originalEvent)}),WORKSPACE.VIEW?d.on("contextmenu",function(e){}):(d.bindPopup(n.Name(),{closeButton:!1,offset:L.point(0,50*e.TokenScale()),closeOnClick:!1,opacity:.7,autoPan:!1}),d.on("click",function(o){e.SelectRow(n)}),d.on("dragend",function(e){var o=e.target;n.LatLng(o.getLatLng())}),d.on("drag",function(e){d.setIconAngle(n.Angle())}),d.on("dblclick",function(e){if("NPC"==n.ModelType()){var o=e.originalEvent;o.stopPropagation(),WORKSPACE.Helpers.ViewNPC(n.Id(),o)}}),d.on("contextmenu",function(e){n.Angle((n.Angle()+45)%360),d.setIconAngle(n.Angle())})),WORKSPACE.GridLayers.push(d),d.addTo(WORKSPACE.GridMap)}})},e.ResetTokens=function(){e.LoadTokens(!0)},e.AddMap=function(o,t){e.MapSlides.push({Source:e.MapToAdd()}),WORKSPACE.ViewModels.GameViewModel.Save(),e.MapToAdd("")},e.RemoveMap=function(o){e.MapSlides.remove(o),WORKSPACE.ViewModels.GameViewModel.Save()},e.ActiveMap.subscribe(function(e){""!==e&&WORKSPACE.Helpers.SwapMap(e)}),e.LoadMap=function(o,t){e.ClearFog(),e.ActiveMap($(t.currentTarget).data("src"))},e.OrderedCombatantList=ko.pureComputed(function(){return e.CombatantList().sort(function(e,o){var t=parseInt(e.Initiative()||0),n=parseInt(o.Initiative()||0);return t<n?1:t>n?-1:t===n?e.Name()<o.Name()?-1:1:void 0})}),e.Difficulty=ko.pureComputed(function(){var o="Unknown",t=[0,0,0,0],n=[],a=[];if($.each(e.CombatantList(),function(e,o){"NPC"==o.ModelType()?a.push(o):"Player"==o.ModelType()?n.push(o):parseInt(o.CR())>=0&&a.push(o)}),!n.length)return o;if($.each(n,function(e,o){if(o.Level()||(t=null),null!==t)for(e=0;e<t.length;e++)t[e]+=WORKSPACE.XPPerLevel[o.Level()][e]}),null!==t){var r=a.length,i=0,l=0,s=0,d=0;d=r<2?0:r<3?1:r<7?2:r<11?3:r<15?4:5,WORKSPACE.ViewModels.PlayersViewModel.PlayersList().length<3&&d++,i=WORKSPACE.Multipliers[d],$.each(a,function(e,o){s+=parseInt(o.XP())}),l=s*i,o=l<t[0]?"Trivial":l<t[1]?"Easy":l<t[2]?"Medium":l<t[3]?"Hard":"Deadly"}return o}),e.AddCombatant=function(o){if(void 0===o)return void e.CombatantList.push(new CombatantModel);var t=!1,n=new CombatantModel;$.each(e.CombatantList(),function(e,n){n.Name()==o.Name&&(t=!0)}),t&&"NPC"!=o.ModelType||(n.Load(o),e.CombatantList.push(n))},e.RemoveCombatant=function(o){e.CombatantList.remove(o)},e.SetActiveTab=function(o){e.ActiveTab(o)},e.BackgroundColor.subscribe(function(e){$("#grid-map").css("background",e)}),e.ShowGridLines.subscribe(function(o){o?($("#grid-lines").css("display","initial"),$("#grid-lines").css("background-image","linear-gradient(to right, "+e.GridColor()+" 1px, transparent 1px), linear-gradient(to bottom, "+e.GridColor()+" 1px, transparent 1px)")):$("#grid-lines").css("display","none")}),e.GridColor.subscribe(function(o){e.ShowGridLines()&&$("#grid-lines").css("background-image","linear-gradient(to right, "+o+" 1px, transparent 1px), linear-gradient(to bottom, "+o+" 1px, transparent 1px)")}),e.DarknessColor.subscribe(function(e){WORKSPACE.VIEW&&WORKSPACE.Helpers.DrawLights()}),e.FogColor.subscribe(function(e){WORKSPACE.Helpers.DrawFog()}),e.ShowFog.subscribe(function(e){var o=$("#grid-fog")[0],t=o.getContext("2d");t.clearRect(0,0,o.width,o.height),WORKSPACE.Helpers.DrawFog()}),e.Load=function(o){WORKSPACE.VIEW||(e.ActiveTab(o.ActiveTab||0),e.Position({Left:o.Position.Left||0,Top:o.Position.Top||0}),e.MapSlides(o.MapSlides||[]),e.IsMinimized(o.IsMinimized)),e.FogColor(o.FogColor||"rgb(0,0,0)"),e.DarknessColor(o.DarknessColor||"rgb(0,0,0)"),e.GridColor(o.GridColor||"#000"),e.BackgroundColor(o.BackgroundColor||"#ddd"),e.ShowOutlines(o.ShowOutlines||!1),e.ShowGridLines(o.ShowGridLines||!1),e.AltGridColor(o.AltGridColor||!1),e.ShowDarkness(o.ShowDarkness||!1),e.ShowFog(o.ShowFog||!1),o.ShowFog&&o.ErasePoints&&(WORKSPACE.ErasePoints=o.ErasePoints),e.ActiveMap(o.ActiveMap||""),$.each(o.CustomIcons,function(e,t){t.name&&""!==t.name||o.CustomIcons.slice(e,1)}),e.CustomIcons(o.CustomIcons||[]),e.TokenScale(o.TokenScale||1),e.GridCenter(o.GridCenter||[0,0]),e.GridZoom(o.GridZoom||1);var t=[];if(o.CombatantList.length>0){for(i=0;i<o.CombatantList.length;i++){var n=new CombatantModel;n.Load(o.CombatantList[i]),t.push(n)}e.CombatantList(t)}}};CombatViewModel.prototype.toJSON=function(){var e=ko.toJS(this);return delete e.LastTimestamp,delete e.TransmitMap,delete e.TransmitMapRemote,delete e.Peer,delete e.PeerConnections,delete e.ConnTimeout,delete e.TriggerUpdate,delete e.MapSlides,delete e.MapSlidesPage,delete e.PageMax,delete e.isPageMin,delete e.isPageMax,delete e.Difficulty,delete e.OrderedCombatantList,e};var GameModel=function(e){var o=this;o.Name=ko.observable(e||""),o.Id=ko.pureComputed(function(){return"WORKSPACE-"+o.Name().toLowerCase()}),o.Name.subscribe(function(e){localStorage.removeItem(o.Id())},o,"beforeChange"),o.Name.subscribe(function(e){WORKSPACE.CurrentGame=o,WORKSPACE.ViewModels.GameViewModel.Save(),WORKSPACE.Save()},o)},GameViewModel=function(){var e=this;e.Selector=null,e.Position=ko.observable({Right:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!1).extend({trackChange:!0}),e.GameList=ko.observableArray([new GameModel("tmp")]),e.SelectedGame=ko.observable(),e.IsLoaded=ko.observable(!1),e.Load=function(o){e.Position({Left:o.Position.Left||0,Top:o.Position.Top||0}),e.IsMinimized(o.IsMinimized),e.LoadGameList(WORKSPACE.GameList),e.LoadSelectedGame(WORKSPACE.CurrentGame)},e.Save=function(){WORKSPACE.SupportsStorage()&&(WORKSPACE.DEBUG&&console.log("Game Model Saving"),localStorage.setItem("WORKSPACE",JSON.stringify({CurrentGame:ko.toJS(e.SelectedGame()),GameList:ko.toJS(e.GameList()),MapSlides:ko.toJS(WORKSPACE.ViewModels.CombatViewModel.MapSlides())})))},e.LoadGameList=function(o){var t=[];$.each(o,function(e,o){var n=new GameModel(o.Name);t.push(n)}),e.GameList(t)},e.LoadSelectedGame=function(o){void 0!==o&&$.each(e.GameList(),function(t,n){n.Name()==o.Name()&&e.SelectedGame(n)})},e.SelectedGame.subscribe(function(o){void 0!==o&&e.IsLoaded(!0)},null,"beforeChange"),e.SelectedGame.subscribe(function(o){e.IsLoaded()&&(e.Save(),location.reload())}),e.AddGame=function(){var o=new GameModel("Game"+(e.GameList().length+1));e.GameList.push(o),e.SelectedGame(o)},e.RemoveGame=function(){var o=e.SelectedGame();WORKSPACE.SupportsStorage()&&null!==localStorage.getItem(o.Id())&&(localStorage.removeItem(o.Id()),e.GameList.remove(o))}},ItemModel=function(){var e=this;e.Id=ko.observable(),e.Name=ko.observable().extend({trackChange:!0}),e.Text=ko.observable().extend({trackChange:!0}),e.IsRemoveVisible=ko.observable(!1),e.ShowRemove=function(){e.IsRemoveVisible(!0)},e.HideRemove=function(){e.IsRemoveVisible(!1)},e.Load=function(o,t){e.Id(o),e.Name(t.name),e.Text(t.text)}},RaritySettingModel=function(e,o,t,n,a,r,i){var l=this;l.Name=ko.observable(e),l.Chance=ko.observable(o),l.Min=ko.observable(t),l.Max=ko.observable(n),l.RangeMin=ko.observable(a),l.RangeMax=ko.observable(r),l.Step=ko.observable(i),l.ChanceText=ko.pureComputed(function(){return l.Chance()+"%"}),l.MinMaxText=ko.pureComputed(function(){return l.Min()+" - "+l.Max()})};RaritySettingModel.prototype.toJSON=function(){var e=ko.toJS(this);return delete e.ChanceText,delete e.MinMaxText,e};var LootViewModel=function(){var e=this;e.Selector=null,e.ActiveTab=ko.observable(0).extend({trackChange:!0}),e.CurrentItemId=0,e.SearchList=ko.observableArray().extend({trackChange:!0}),e.GenerateList=ko.observableArray().extend({trackChange:!0}),e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.Search=ko.observable("").extend({rateLimit:500,trackChange:!0}),e.Type=ko.observableArray(["Individual","Hoard"]),e.SelectedType=ko.observable(),e.RaritySettings=ko.observableArray([new RaritySettingModel("Coin",100,200,600,0,5e4,100),new RaritySettingModel("Common",60,1,6,0,10,1),new RaritySettingModel("Uncommon",30,1,6,0,10,1),new RaritySettingModel("Rare",10,1,4,0,10,1),new RaritySettingModel("Very Rare",3,1,4,0,10,1),new RaritySettingModel("Legendary",1,1,1,0,10,1),new RaritySettingModel("Artifact",0,0,0,0,10,1),new RaritySettingModel("Unique",0,0,0,0,10,1)]),e.Rarity=ko.observableArray(["Coin","Common","Uncommon","Rare","Very Rare","Legendary","Artifact","Unique"]),e.SelectedRarity=ko.observableArray(),e.SearchRarity=ko.observableArray(["ANY","Common","Uncommon","Rare","Very Rare","Legendary","Artifact","Unique"]),e.SelectedSearchRarity=ko.observableArray().extend({trackChange:!0}),e.SearchGrid=new ko.simpleGrid.viewModel({data:e.SearchList,type:"lootsearch",columns:[{headerText:"Name",rowText:"Name"},{headerText:"Attune",rowText:"Attune"},{headerText:"Rarity",rowText:"Rarity"},{headerText:"Id",rowText:"Id"}],pageSize:6}),e.GenerateGrid=new ko.simpleGrid.viewModel({data:e.GenerateList,columns:[{headerText:"Coin",rowText:"Coin"},{headerText:"Magic",rowText:"Magic"}],pageSize:6}),e.SelectedRarity.subscribe(function(e){}),e.SetActiveTab=function(o){e.ActiveTab(o)},e.Load=function(o){if(e.ActiveTab(o.ActiveTab||0),e.Search(o.Search||""),e.GenerateList(o.GenerateList||[]),e.SelectedType(o.SelectedType||"Individual"),e.SelectedRarity(o.SelectedRarity||"Coin"),e.SelectedSearchRarity(o.SelectedSearchRarity||"ANY"),e.Position({Left:o.Position.Left||0,Top:o.Position.Top||0}),e.IsMinimized(o.IsMinimized),o.RaritySettings){var t=[];$.each(o.RaritySettings,function(e,o){t.push(new RaritySettingModel(o.Name,o.Chance,o.Min,o.Max,o.RangeMin,o.RangeMax,o.Step))}),e.RaritySettings(t)}},e.Search.subscribe(function(o){e.RunSearch()}),e.SelectedSearchRarity.subscribe(function(o){e.RunSearch()}),e.PickRandom=function(){e.SearchList().length>1?e.PickRandomAction():(e.RunSearch(),e.PickRandomAction())},e.PickRandomAction=function(){if(e.SearchList().length>1){var o=WORKSPACE.Helpers.Roll(1,e.SearchList().length)-1,t=e.SearchList()[o];e.SearchList.removeAll(),e.SearchGrid.currentPageIndex(0),e.SearchList.push(t)}},e.RunSearch=function(){if(""===e.Search()&&"ANY"==e.SelectedSearchRarity())return e.SearchList.removeAll(),void e.SearchGrid.currentPageIndex(0);e.SearchList.removeAll(),e.SearchGrid.currentPageIndex(0);var o=[];$.each(MAGIC,function(t,n){n.name.toLowerCase().indexOf(e.Search().toLowerCase())!==-1&&("ANY"==e.SelectedSearchRarity()||void 0!==n.rarity&&n.rarity.toLowerCase()==e.SelectedSearchRarity().toLowerCase())&&o.push(t)});var t=[];for(i=0;i<o.length;i++)t.push({Id:o[i],Name:MAGIC[o[i]].name,Rarity:MAGIC[o[i]].rarity,Attune:MAGIC[o[i]].attune});e.SearchList(t)},e.Generate=function(){e.GenerateList.removeAll(),e.GenerateGrid.currentPageIndex(0);var o=e.Amount().split("d");2!=o.length}};LootViewModel.prototype.toJSON=function(){var e=ko.toJS(this);return delete e.Rarity,delete e.SearchRarity,delete e.SearchList,delete e.SearchGrid,delete e.GenerateList,delete e.GenerateGrid,e};var NPCModel=function(){var e=this;e.ModelType="NPC",e.Id=ko.observable().extend({trackChange:!0}),e.Name=ko.observable().extend({trackChange:!0}),e.Description=ko.observable().extend({trackChange:!0}),e.Size=ko.observable().extend({trackChange:!0}),e.Type=ko.observable().extend({trackChange:!0}),e.Alignment=ko.observable().extend({trackChange:!0}),e.AC=ko.observable().extend({trackChange:!0}),e.HP=ko.observable().extend({trackChange:!0}),e.Speed=ko.observable().extend({trackChange:!0}),e.STR=ko.observable().extend({trackChange:!0}),e.DEX=ko.observable().extend({trackChange:!0}),e.CON=ko.observable().extend({trackChange:!0}),e.INT=ko.observable().extend({trackChange:!0}),e.WIS=ko.observable().extend({trackChange:!0}),e.CHA=ko.observable().extend({trackChange:!0}),e.Skill=ko.observable().extend({trackChange:!0}),e.Resist=ko.observable().extend({trackChange:!0}),e.Senses=ko.observable().extend({trackChange:!0}),e.Passive=ko.observable().extend({trackChange:!0}),e.Languages=ko.observable().extend({trackChange:!0}),e.CR=ko.observable().extend({trackChange:!0}),e.Trait=ko.observableArray().extend({trackChange:!0}),e.Action=ko.observableArray().extend({trackChange:!0}),e.Immune=ko.observable().extend({trackChange:!0}),e.ConditionImmune=ko.observable().extend({trackChange:!0}),e.Spells=ko.observable().extend({trackChange:!0}),e.Legendary=ko.observableArray().extend({trackChange:!0}),e.Save=ko.observable().extend({trackChange:!0}),e.Source=ko.observable().extend({trackChange:!0}),e.Vulnerable=ko.observable().extend({trackChange:!0}),e.Reaction=ko.observableArray().extend({trackChange:!0}),e.IsRemoveVisible=ko.observable(!1),e.Similar=ko.observableArray(),e.SelectedSimilar=ko.observableArray().extend({trackChange:!0}),e.PopulateSimilar=function(){if(void 0===e.Id())return[{Id:0,Name:"None [0]",Cost:0}];var o=[];$.each(MONSTERS,function(t,n){if(e.Name()!=n.name){var a={Id:t,Name:n.name,Cost:0};a.Cost+=e.Name().levenstein(n.name),a.Cost+=5*e.Type().levenstein(n.type),a.Cost+=e.CR().levenstein(n.cr),a.Cost+=e.AC().levenstein(n.ac),a.Cost+=5*e.Alignment().levenstein(n.alignment),a.Cost+=e.HP().split(" ")[0].levenstein(n.hp.split(" ")[0]),o.push(a)}}),o.sort(function(e,o){return e.Cost<o.Cost?-1:1}),e.Similar(o.slice(1,11))},e.SelectedSimilar.subscribe(function(e){void 0!==e&&(WORKSPACE.NPCView.dialog("close"),WORKSPACE.NPCViewVM.Load(e.Id,MONSTERS[e.Id]),WORKSPACE.ViewModels.NPCsViewModel.CurrentNPCId=e.Id,WORKSPACE.NPCView.dialog("option","title",MONSTERS[e.Id].name),WORKSPACE.NPCView.dialog("open"),WORKSPACE.NPCViewVM.PopulateSimilar())}),e.ShowRemove=function(){e.IsRemoveVisible(!0)},e.HideRemove=function(){e.IsRemoveVisible(!1)},e.PassivePerception=ko.pureComputed(function(){return"passive perception "+e.Passive()}),e.TotalSenses=ko.pureComputed(function(){var o=e.Senses(),t=e.PassivePerception();return o&&t?o+"; "+t:o?o:t?t:null}),e.XP=ko.pureComputed(function(){return WORKSPACE.XPPerCR[e.CR()]}),e.Challenge=ko.pureComputed(function(){return e.CR()+" ("+e.XP()+" XP)"}),e.SizeText=ko.pureComputed(function(){switch(e.Size()){case"F":return"Fine";case"D":return"Diminutive";case"T":return"Tiny";case"S":return"Small";case"M":return"Medium";case"L":return"Large";case"H":return"Huge";case"G":return"Gargantuan";case"C":return"Colossal";default:return"(Unknown Size)"}}),e.BasicDescription=ko.pureComputed(function(){return e.SizeText()+" "+e.Type()+", "+e.Alignment()}),e.STRMOD=ko.pureComputed(function(){return e.MOD(e.STR())}),e.DEXMOD=ko.pureComputed(function(){return e.MOD(e.DEX())}),e.CONMOD=ko.pureComputed(function(){return e.MOD(e.CON())}),e.INTMOD=ko.pureComputed(function(){return e.MOD(e.INT())}),e.WISMOD=ko.pureComputed(function(){return e.MOD(e.WIS())}),e.CHAMOD=ko.pureComputed(function(){return e.MOD(e.CHA())}),e.MOD=function(e){var o=Math.floor((e-10)/2);return o>0?"+"+o:o},e.Load=function(o,t){e.Id(o),e.Name(t.name||""),e.Description(t.description||""),e.Size(t.size||""),e.Type(t.type||""),e.Alignment(t.alignment||""),e.AC(t.ac||""),e.HP(t.hp||""),e.Speed(t.speed||""),e.STR(t.str||""),e.DEX(t.dex||""),e.CON(t.con||""),e.INT(t.int||""),e.WIS(t.wis||""),e.CHA(t.cha||""),e.Skill(t.skill||""),e.Resist(t.resist||""),e.Senses(t.senses||""),e.Passive(t.passive||""),e.Languages(t.languages||""),e.CR(t.cr||""),e.Trait(t.trait||[]),e.Action(t.action||[]),e.Immune(t.immune||""),e.ConditionImmune(t.conditionImmune||""),e.Spells(t.spells||""),e.Legendary(t.legendary||[]),e.Save(t.save||""),e.Source(t.source||""),e.Vulnerable(t.vulnerable||""),e.Reaction(t.reaction||[])}};NPCModel.prototype.toJSON=function(){return{Id:ko.utils.unwrapObservable(this.Id)}};var GroupModel=function(e){var o=this;o.NPCs=ko.observableArray().extend({trackChange:!0}),o.Title=ko.observable(e||"").extend({rateLimit:500,trackChange:!0}),o.Load=function(e){o.Title(e.Title||""),$.each(e.NPCs,function(e,t){o.AddNPC(t.Id)})},o.NPCsByCR=ko.pureComputed(function(){return o.NPCs().sort(function(e,o){var t=e.CR().split("/"),n=o.CR().split("/"),a=t.length>1?parseInt(t[0],10)/parseInt(t[1],10):parseInt(t[0]),r=n.length>1?parseInt(n[0],10)/parseInt(n[1],10):parseInt(n[0]);return a<r?-1:a>r?1:a===r?e.Name()<o.Name()?-1:1:void 0})}),o.Difficulty=ko.pureComputed(function(){var e="Unknown",t=[0,0,0,0];if(!WORKSPACE.ViewModels.PlayersViewModel.PlayersList().length)return e;if($.each(WORKSPACE.ViewModels.PlayersViewModel.PlayersList(),function(e,o){if(!o.Level())return void(t=null);for(e=0;e<t.length;e++)t[e]+=WORKSPACE.XPPerLevel[o.Level()][e]}),null!==t){var n=o.NPCs().length,a=0,r=0,i=0,l=0;l=n<2?0:n<3?1:n<7?2:n<11?3:n<15?4:5,WORKSPACE.ViewModels.PlayersViewModel.PlayersList().length<3&&l++,a=WORKSPACE.Multipliers[l],$.each(o.NPCs(),function(e,o){i+=parseInt(o.XP())}),r=i*a,e=r<t[0]?"Trivial":r<t[1]?"Easy":r<t[2]?"Medium":r<t[3]?"Hard":"Deadly"}return e}),o.AddNPC=function(e){var t=new NPCModel;t.Load(e,MONSTERS[e]),o.NPCs.push(t)},o.RemoveNPC=function(e){o.NPCs.remove(e)}};GroupModel.prototype.toJSON=function(){var e=ko.toJS(this);return delete e.Difficulty,delete e.NPCsByCR,e};var NPCsViewModel=function(){var e=this;e.Selector=null,e.ActiveTab=ko.observable(0).extend({trackChange:!0}),e.CurrentNPCId=0,e.Search=ko.observable("").extend({rateLimit:500}).extend({trackChange:!0}),e.Type=ko.observable("").extend({rateLimit:500}).extend({trackChange:!0}),e.CRList=ko.observableArray(WORKSPACE.CRArray),e.CR=ko.observable("").extend({rateLimit:500}).extend({trackChange:!0}),e.SearchList=ko.observableArray(),e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.GroupList=ko.observableArray([new GroupModel("Group1")]).extend({trackChange:!0}),e.SelectedGroup=ko.observable().extend({trackChange:!0}),e.SetActiveTab=function(o){e.ActiveTab(o)},e.Load=function(o){e.ActiveTab(o.ActiveTab||0),e.Position({Left:o.Position.Left||0,Top:o.Position.Top||0}),e.IsMinimized(o.IsMinimized),e.Search(o.Search||""),e.Type(o.Type||""),e.CR(o.CR||"");var t=[];o.GroupList.length>0&&($.each(o.GroupList,function(n,a){var r=o.GroupList[n],i=new GroupModel;i.Load(r),o.SelectedGroup.Title==r.Title&&e.SelectedGroup(i),t.push(i)}),e.GroupList(t))},e.SendCombat=function(){$.each(e.SelectedGroup().NPCs(),function(e,o){WORKSPACE.ViewModels.CombatViewModel.AddCombatant(ko.toJS(o))})},e.AddGroup=function(){var o=new GroupModel("Group"+(e.GroupList().length+1));e.GroupList.push(o),e.SelectedGroup(o)},e.RemoveGroup=function(o){1==e.GroupList().length&&e.GroupList.push(new GroupModel("Group1")),e.GroupList.remove(o)},e.SearchGrid=new ko.simpleGrid.viewModel({data:e.SearchList,type:"npcs",columns:[{headerText:"Id",rowText:"Id"},{headerText:"Name",rowText:"Name"},{headerText:"Type",rowText:"Type"},{headerText:"CR",rowText:"CR"}],pageSize:6}),e.Type.subscribe(function(o){e.RunSearch()}),e.CR.subscribe(function(o){e.RunSearch()}),e.Search.subscribe(function(o){e.RunSearch()}),e.RunSearch=function(){if(""===e.Search()&&""===e.Type()&&""===e.CR())return e.SearchList.removeAll(),void e.SearchGrid.currentPageIndex(0);e.SearchList.removeAll(),e.SearchGrid.currentPageIndex(0);var o=[];$.each(MONSTERS,function(t,n){""!==e.Search()&&n.name.toLowerCase().indexOf(e.Search().toLowerCase())===-1||""!==e.Type()&&n.type.toLowerCase().indexOf(e.Type().toLowerCase())===-1||""!==e.CR()&&n.cr!=e.CR()||o.push({Id:t,Name:n.name,Type:n.type,CR:n.cr})}),o.sort(function(e,o){var t=e.CR.split("/"),n=o.CR.split("/"),a=t.length>1?parseInt(t[0],10)/parseInt(t[1],10):parseInt(t[0]),r=n.length>1?parseInt(n[0],10)/parseInt(n[1],10):parseInt(n[0]);return a<r?-1:a>r?1:a===r?e.Name<o.Name?-1:1:void 0}),e.SearchList(o)}};NPCsViewModel.prototype.toJSON=function(){var e=ko.toJS(this);return delete e.SearchList,delete e.CRList,delete e.SearchGrid,e};var PlayerModel=function(e,o,t,n,a,r){var i=this;i.ModelType="Player",i.Name=ko.observable(e||"").extend({trackChange:!0}),i.AC=ko.observable(o||"").extend({trackChange:!0}),i.Class=ko.observable(t||"").extend({trackChange:!0}),i.Passive=ko.observable(n||"").extend({trackChange:!0}),i.Level=ko.observable(a||"").extend({trackChange:!0}),i.XP=ko.observable(r||"").extend({trackChange:!0})},PlayersViewModel=function(){var e=this;e.Selector=null,e.PlayersList=ko.observableArray().extend({trackChange:!0}),e.Player=new PlayerModel,e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.SendCombat=function(){$.each(e.PlayersList(),function(e,o){WORKSPACE.ViewModels.CombatViewModel.AddCombatant(ko.toJS(o))})},e.AddPlayer=function(){e.PlayersList.push(new PlayerModel)},e.RemovePlayer=function(o){e.PlayersList.remove(o)},e.Load=function(o){e.Position({Left:o.Position.Left||0,Top:o.Position.Top||0}),e.IsMinimized(o.IsMinimized);var t=[];if(o.PlayersList.length>0){for(i=0;i<o.PlayersList.length;i++)t.push(new PlayerModel(o.PlayersList[i].Name,o.PlayersList[i].AC,o.PlayersList[i].Class,o.PlayersList[i].Passive,o.PlayersList[i].Level,o.PlayersList[i].XP));e.PlayersList(t)}}},RollModel=function(){var e=this;e.Amount=ko.observable(0).extend({trackChange:!0}),e.Dice=ko.observable(0).extend({trackChange:!0}),e.Modifier=ko.observable(0).extend({trackChange:!0}),e.Load=function(o){e.Amount(o.Amount||0),e.Dice(o.Dice||0),e.Modifier(o.Modifier||0)},e.String=ko.pureComputed(function(){return e.Amount()+"d"+e.Dice()+(e.Modifier>0)?" +"+e.Modifier():e.Modifier()<0?" "+e.Modifier():""})},RollViewModel=function(){var e=this;e.Selector=null,e.RollList=ko.observableArray().extend({trackChange:!0}),e.Selected=ko.observable().extend({trackChange:!0}),e.Result=ko.observable().extend({trackChange:!0}),e.ResultBreakdown=ko.observableArray().extend({trackChange:!0}),e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.MatchDiceSet=/(\-?\+?\d+d\d+)/gi,e.MatchDice=/(\d+)d(\d+)/i,e.MatchMod=/[+\-]*(\.\d+|\d+(\.\d+)?)/g,e.RollString=ko.observable("").extend({trackChange:!0}),e.BreakdownString=ko.pureComputed(function(){var o="",t=e.ResultBreakdown();return $.each(t,function(e,t){o+=t.String+"  ["+t.Rolls.toString()+"]\n"}),o}),e.RollList.subscribe(function(o){e.RollList().length>10&&e.RollList.shift()}),e.Selected.subscribe(function(o){void 0!==o&&(e.Result(""),e.ResultBreakdown.removeAll(),e.RollString(o))}),e.ExecuteRoll=function(){var o=0,t=0,n=null,r=null,i=null,l=e.RollString();if(e.MatchDiceSet.lastIndex=0,e.ResultBreakdown.removeAll(),e.Result(""),e.MatchDiceSet.test(l)!==!1){
for(r=l.match(e.MatchDiceSet),s=0;s<r.length;s++){var d={String:r[s],Rolls:[]};for(n=r[s].match(e.MatchDice),a=0;a<n[1];a++){var c=WORKSPACE.Helpers.Roll(1,n[2]);d.Rolls.push(c),"-"==r[s][0]&&(c*=-1),o+=c}e.ResultBreakdown.push(d),l=l.replace(r[s],"")}if(e.MatchMod.lastIndex=0,e.MatchMod.test(l)!==!1){for(i=l.match(e.MatchMod);i.length;)t+=parseFloat(i.shift());e.ResultBreakdown.push({String:"Mod",Rolls:[t]})}e.Result(o+t),e.AddRoll(e.RollString())}},e.AddRoll=function(o){e.RollList().indexOf(o)===-1&&e.RollList.push(o)},e.RemoveRoll=function(o){e.RollList.remove(o)},e.Load=function(o){e.Position({Left:o.Position.Left||0,Top:o.Position.Top||0}),e.IsMinimized(o.IsMinimized),e.RollString(o.RollString||""),e.Result(o.Result||""),e.RollList(o.RollList||[])}},SaveViewModel=function(){var e=this;e.Running=ko.observable(0),e.Running.subscribe(function(o){WORKSPACE.DEBUG&&console.log("Saving"),WORKSPACE.Save(),e.Running(0)}),e.Run=function(){e.Running(e.Running()+1)}},SpellModel=function(){var e=this;e.Id=ko.observable(),e.Level=ko.observable().extend({trackChange:!0}),e.Name=ko.observable().extend({trackChange:!0}),e.Type=ko.observable().extend({trackChange:!0}),e.Cast=ko.observable().extend({trackChange:!0}),e.Range=ko.observable().extend({trackChange:!0}),e.Components=ko.observable().extend({trackChange:!0}),e.Materials=ko.observable().extend({trackChange:!0}),e.Duration=ko.observable().extend({trackChange:!0}),e.Description=ko.observable().extend({trackChange:!0}),e.Class=ko.observable().extend({trackChange:!0}),e.IsRemoveVisible=ko.observable(!1),e.MaterialsValue=ko.pureComputed(function(){return e.Materials()?"("+e.Materials()+")":""}),e.ShowRemove=function(){e.IsRemoveVisible(!0)},e.HideRemove=function(){e.IsRemoveVisible(!1)},e.Load=function(o,t){e.Id(o),e.Level(t.Level),e.Name(t.Name),e.Type(t.Type),e.Cast(t.Cast),e.Range(t.Range),e.Components(t.Components),e.Materials(t.Materials),e.Duration(t.Duration),e.Description(t.Description),e.Class(t.Class)}};SpellModel.prototype.toJSON=function(){return{Id:ko.utils.unwrapObservable(this.Id)}};var SpellbookModel=function(e){var o=this;o.Spells=ko.observableArray().extend({trackChange:!0}),o.Title=ko.observable(e||"").extend({rateLimit:500,trackChange:!0}),o.ShowSlots=ko.observable(!0).extend({trackChange:!0}),o.SpellSlots=ko.observableArray([{Slots:[0,0,0,0]},{Slots:[0,0,0]},{Slots:[0,0,0]},{Slots:[0,0,0]},{Slots:[0,0,0]},{Slots:[0,0]},{Slots:[0,0]},{Slots:[0]},{Slots:[0]}]),o.SlotsUsed=ko.observableArray().extend({trackChange:!0}),o.Load=function(e){o.Title(e.Title||""),o.ShowSlots(e.ShowSlots||!1),o.SlotsUsed(e.SlotsUsed||[]),$.each(e.Spells,function(e,t){o.AddSpell(t.Id)})},o.ResetSlots=function(){o.SlotsUsed([])},o.SpellsByLevel=ko.pureComputed(function(){var e=o.Spells(),t=[],n=[];return 0===e.length?e:($.each(e,function(e,o){$.inArray(o.Level(),t)===-1&&t.push(o.Level())}),t.sort(),$.each(t,function(o,t){var a={Key:t,Spells:[]};$.each(e,function(e,o){o.Level()==t&&a.Spells.push(o)}),n.push(a)}),n)}),o.ToggleSlots=function(){o.ShowSlots(!o.ShowSlots())},o.AddSpell=function(e){var t=!1;if($.each(o.Spells(),function(o,n){n.Id()==e&&(t=!0)}),!t){var n=new SpellModel;n.Load(e,SPELLS[e]),o.Spells.push(n)}},o.RemoveSpell=function(e){o.Spells.remove(e)}};SpellbookModel.prototype.toJSON=function(){var e=ko.toJS(this);return delete e.SpellsByLevel,delete e.SpellSlots,e};var SpellsViewModel=function(){var e=this;e.Selector=null,e.ActiveTab=ko.observable(0).extend({trackChange:!0}),e.SearchList=ko.observableArray().extend({rateLimit:500}),e.Search=ko.observable("").extend({rateLimit:500,trackChange:!0}),e.Class=ko.observable("").extend({rateLimit:500,trackChange:!0}),e.Level=ko.observable().extend({rateLimit:500,trackChange:!0}),e.LevelList=ko.observableArray(["","Cantrip",1,2,3,4,5,6,7,8,9]),e.BookList=ko.observableArray([new SpellbookModel("Book1")]).extend({trackChange:!0}),e.SelectedBook=ko.observable().extend({trackChange:!0}),e.SelectedBookAddSpell=ko.observable(),e.Spellbook=ko.observable(),e.CurrentSpellId=0,e.Position=ko.observable({Left:0,Top:0}).extend({trackChange:!0}),e.IsMinimized=ko.observable(!0).extend({trackChange:!0}),e.SearchGrid=new ko.simpleGrid.viewModel({data:e.SearchList,type:"spells",columns:[{headerText:"Id",rowText:"Id"},{headerText:"Level",rowText:"Level"},{headerText:"Name",rowText:"Name"}],pageSize:6}),e.AddBook=function(){var o=new SpellbookModel("Book"+(e.BookList().length+1));e.BookList.push(o),e.SelectedBook(o)},e.RemoveBook=function(o){1==e.BookList().length&&e.BookList.push(new SpellbookModel("Book1")),e.BookList.remove(o)},e.SetActiveTab=function(o){e.ActiveTab(o)},e.Load=function(o){e.ActiveTab(o.ActiveTab||0),e.Position({Left:o.Position.Left||0,Top:o.Position.Top||0}),e.IsMinimized(o.IsMinimized),e.Search(o.Search||""),e.Class(o.Class||""),e.Level(o.Level||"");var t=[];o.BookList.length>0&&($.each(o.BookList,function(n,a){var r=o.BookList[n],i=new SpellbookModel;i.Load(r),o.SelectedBook.Title==r.Title&&e.SelectedBook(i),t.push(i)}),e.BookList(t))},e.RunSearch=function(){e.SearchList.removeAll(),e.SearchGrid.currentPageIndex(0);var o="Cantrip"===e.Level()?"0":e.Level();if(""!==e.Search()||""!==e.Class()||""!==o){$.each(SPELLS,function(t,n){(""===e.Class()||""!==e.Class()&&n.Class.toLowerCase().indexOf(e.Class().toLowerCase())!==-1)&&(""===e.Search()||""!==e.Search()&&n.Name.toLowerCase().indexOf(e.Search().toLowerCase())!==-1)&&(""===o||""!==o&&n.Level==o)&&e.SearchList.push({Id:t,Level:SPELLS[t].Level,Name:SPELLS[t].Name,Data:SPELLS[t]})}),e.SearchList.sort(function(e,o){return e.Level<o.Level?-1:e.Level>o.Level?1:e.Level==o.Level?e.Name<o.Name?-1:1:void 0})}},e.Search.subscribe(function(o){e.RunSearch()},this),e.Class.subscribe(function(o){e.RunSearch()},this),e.Level.subscribe(function(o){e.RunSearch()},this)};SpellsViewModel.prototype.toJSON=function(){var e=ko.toJS(this);return delete e.LevelList,delete e.SearchList,delete e.SearchGrid,e};